---
title: nginx反向代理导致接口响应超时
categories: 
	- nginx
tags: 
	- Linux
	- nginx
date: 2023-07-18 16:45:20
---
<!-- toc -->

## <span id="inline-blue">代理访问路径</span>

接口真实访问地址：http://10.26.0.19:9001/prodtest/admin/user/getCaptcha?width=140&height=50

接口代理访问地址：http://10.26.0.19:8080/prodtest/admin/user/getCaptcha?width=140&height=50

## <span id="inline-blue">配置详情</span>
前端访问接口耗时接近10秒，nginx代理超时配置配置多少都是等待超时然后请求报错
```shell
server {
		client_max_body_size 1024m; 
        listen       8080;
        server_name  10.26.0.19;
		try_files $uri $uri/ /index.html;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
			#gzip_static on; # 开启后查找.gz结尾的文件直接返回，不进行压缩
			gzip_min_length 1k; # 文件大于1K才进行压缩
			gzip_http_version 1.1; # 设置gzip针对的http协议版本
			gzip_comp_level 9; # 压缩级别，1-9，数字越大压缩越好，越占用cpu
			gzip_types  text/css application/javascript; # 进行压缩的文件类型
			autoindex on;
            root   /home/prodtest/dist-protest;
            index  index.html index.htm;
			try_files $uri $uri/ /index.html;
        }
		
		# 反向代理
        location /prodtest {
			 #gzip_static on; # 开启后查找.gz结尾的文件直接返回，不进行压缩
			 gzip_min_length 1k; # 文件大于1K才进行压缩
			 gzip_http_version 1.1; # 设置gzip针对的http协议版本
			 gzip_comp_level 9; # 压缩级别，1-9，数字越大压缩越好，越占用cpu
			 gzip_types  text/css application/javascript; # 进行压缩的文件类型
             proxy_pass http://10.26.0.19:9001/prodtest;
             proxy_set_header Host 10.26.0.19;
             proxy_connect_timeout 10;
             proxy_send_timeout 10;
             proxy_read_timeout 10;
             send_timeout 10;
		}
```

## <span id="inline-blue">原因</span>
域名解析导致
 文件/etc/resolv.conf配置内容如下：
```shell
#; generated by /usr/sbin/dhclient-script
search openstacklocal novalocal
#nameserver 114.114.114.114
#nameserver 8.8.8.8
nameserver 10.26.0.2
nameserver 10.26.0.1
nameserver 10.26.0.3
```
search openstacklocal novalocal 
search 的作用：
当访问的域名不能被DNS解析时，resolver会将该域名加上search后面指定的参数，重新请求DNS，直到被正确解析或试完search指定的列表为止。
示例：主机名为app1.novalocal，请求主机名对应的服务nacos，端口连接变成app1.novalocal.novalocal
```shell
[root@app1.novalocal etc]# lsof -i:9848
COMMAND   PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
java     5579 root   73u  IPv6 37126139      0t0  TCP app1.novalocal.novalocal:51446->app1.novalocal:9848 (ESTABLISHED)
java     5579 root   76u  IPv6 37130258      0t0  TCP app1.novalocal.novalocal:51452->app1.novalocal:9848 (ESTABLISHED)
java     9071 root    9u  IPv6 32331770      0t0  TCP app1.novalocal:58587->app1.novalocal:9848 (ESTABLISHED)
java     9071 root   72u  IPv6 32329519      0t0  TCP app1.novalocal:58598->app1.novalocal:9848 (ESTABLISHED)
java    28503 root   25u  IPv6 37128402      0t0  TCP app1.novalocal:9848->app1.novalocal:51446 (ESTABLISHED)
java    28503 root  200u  IPv6 31969988      0t0  TCP *:9848 (LISTEN)
java    28503 root  284u  IPv6 32242521      0t0  TCP app1.novalocal:9848->app1.novalocal:57686 (ESTABLISHED)
java    28503 root  287u  IPv6 37128424      0t0  TCP app1.novalocal:9848->app1.novalocal:51452 (ESTABLISHED)
java    28503 root  289u  IPv6 32126224      0t0  TCP app1.novalocal:9848->app1.novalocal:56532 (ESTABLISHED)
java    28503 root  290u  IPv6 32329520      0t0  TCP app1.novalocal:9848->app1.novalocal:58598 (ESTABLISHED)
java    28503 root  292u  IPv6 32242558      0t0  TCP app1.novalocal:9848->app1.novalocal:57700 (ESTABLISHED)
java    28503 root  295u  IPv6 32128146      0t0  TCP app1.novalocal:9848->app1.novalocal:56550 (ESTABLISHED)
java    28503 root  296u  IPv6 32331775      0t0  TCP app1.novalocal:9848->app1.novalocal:58587 (ESTABLISHED)
java    28503 root  299u  IPv6 32125133      0t0  TCP app1.novalocal:9848->app1.novalocal:56558 (ESTABLISHED)
java    28503 root  303u  IPv6 32125156      0t0  TCP app1.novalocal:9848->app1.novalocal:56582 (ESTABLISHED)
java    28503 root  304u  IPv6 32121662      0t0  TCP app1.novalocal:9848->app1.novalocal:56572 (ESTABLISHED)
java    28503 root  306u  IPv6 32127363      0t0  TCP app1.novalocal:9848->app1.novalocal:56598 (ESTABLISHED)
java    28503 root  307u  IPv6 32125183      0t0  TCP app1.novalocal:9848->app1.novalocal:56587 (ESTABLISHED)
java    28503 root  317u  IPv6 32123270      0t0  TCP app1.novalocal:9848->app1.novalocal:56614 (ESTABLISHED)
java    28551 root   10u  IPv6 32242520      0t0  TCP app1.novalocal:57686->app1.novalocal:9848 (ESTABLISHED)
java    28551 root   24u  IPv6 32238089      0t0  TCP app1.novalocal:57700->app1.novalocal:9848 (ESTABLISHED)
java    32458 root    6u  IPv6 32124384      0t0  TCP app1.novalocal:56532->app1.novalocal:9848 (ESTABLISHED)
java    32458 root   77u  IPv6 32121614      0t0  TCP app1.novalocal:56550->app1.novalocal:9848 (ESTABLISHED)
java    32542 root    7u  IPv6 32125129      0t0  TCP app1.novalocal:56558->app1.novalocal:9848 (ESTABLISHED)
java    32542 root   76u  IPv6 32125155      0t0  TCP app1.novalocal:56582->app1.novalocal:9848 (ESTABLISHED)
java    32580 root    7u  IPv6 32125151      0t0  TCP app1.novalocal:56572->app1.novalocal:9848 (ESTABLISHED)
java    32580 root   76u  IPv6 32123269      0t0  TCP app1.novalocal:56614->app1.novalocal:9848 (ESTABLISHED)
java    32627 root   77u  IPv6 32122582      0t0  TCP app1.novalocal:56598->app1.novalocal:9848 (ESTABLISHED)
java    32627 root   78u  IPv6 32124395      0t0  TCP app1.novalocal:56587->app1.novalocal:9848 (ESTABLISHED)
```


## <span id="inline-blue">解决办法</span>

修改/etc/resolv.conf配置内容如下：
```shell
#; generated by /usr/sbin/dhclient-script
#search openstacklocal novalocal
#nameserver 114.114.114.114
#nameserver 8.8.8.8
nameserver 10.26.0.2
nameserver 10.26.0.1
nameserver 10.26.0.3
```

修改/etc/hosts配置内容如下：
```shell
#60.190.232.46 open.ys7.com
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.26.0.19 app1
```
重新请求恢复正常。




