<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":200,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/config.min.js"></script><meta property="og:type" content="website"><meta property="og:title" content="vanishke随笔"><meta property="og:url" content="https://github.com/vanishke/hexo/page/2/index.html"><meta property="og:site_name" content="vanishke随笔"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="vanishke"><meta property="article:tag" content="Java,Elasticsearch,MySQL,Linux"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://github.com/vanishke/hexo/page/2/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/2/index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>vanishke随笔</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">vanishke随笔</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">善始者实繁，克终者盖寡</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">82</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">47</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">210</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="vanishke" src="/images/avatar.png"><p class="site-author-name" itemprop="name">vanishke</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">210</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">47</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">82</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/vanishke" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vanishke"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:18685129726@163.com" title="E-Mail → mailto:18685129726@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-recent-posts motion-element"><div class="links-of-recent-posts-title"><i class="fa fa-history fa-fw"></i> 最近文章</div><ul class="links-of-recent-posts-list"><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Docker%E5%AE%9E%E7%8E%B0nginx%E8%B4%9F%E8%BD%BDemqx%E9%9B%86%E7%BE%A4/" title="Docker&#x2F;blogs&#x2F;Docker实现nginx负载emqx集群&#x2F;">Docker实现nginx负载emqx集群</a></li><li class="links-of-recent-posts-item"><a href="/Emqx/blogs/Docker%E9%83%A8%E7%BD%B2emqx%E9%9B%86%E7%BE%A4/" title="Emqx&#x2F;blogs&#x2F;Docker部署emqx集群&#x2F;">Docker部署emqx集群</a></li><li class="links-of-recent-posts-item"><a href="/MapStruct-plus/blogs/MapStruct-plus%E5%AE%9E%E7%8E%B0JavaBean%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/" title="MapStruct-plus&#x2F;blogs&#x2F;MapStruct-plus实现JavaBean类型转换&#x2F;">MapStruct-plus实现JavaBean类型转换</a></li><li class="links-of-recent-posts-item"><a href="/Mayfly-go/blogs/mayfly-go%E7%99%BB%E5%BD%95%E6%8F%90%E7%A4%BAdatabase%20is%20locked(SQLITE_BUSY)/" title="Mayfly-go&#x2F;blogs&#x2F;mayfly-go登录提示database is locked(SQLITE_BUSY)&#x2F;">mayfly-go登录提示database is locked(SQLITE_BUSY)</a></li><li class="links-of-recent-posts-item"><a href="/SpringBoot/blogs/SpringBoot3%E5%8D%87%E7%BA%A7%E8%AE%B0%E5%BD%95/" title="SpringBoot&#x2F;blogs&#x2F;SpringBoot3升级记录&#x2F;">SpringBoot3升级记录</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/vanishke" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%20Harbor%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%20Harbor%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6/" class="post-title-link" itemprop="url">Docker Harbor配置自定义安全证书</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-14 16:56:36" itemprop="dateCreated datePublished" datetime="2025-01-14T16:56:36+08:00">2025-01-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.1k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E8%87%AA%E5%AE%9A%E4%B9%89https%E8%AF%81%E4%B9%A6span"><span id="inline-blue">自定义https证书</span></a></li><li><a href="#span-idinline-blue%E9%AA%8C%E8%AF%81span"><span id="inline-blue">验证</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Linux: CentOS Linux release 7.7.1908 (Core)<br>Docker：26.1.4<br>Docker compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>线上Docker环境部署容器，在portainer容器可视化管理工具的支持下，部署方便了很多，但镜像不想暴露到公网环境上，于是部署了Harbor私有镜像仓库，但安全传输成了大问题，以下通过生成自签名证书实现harbor安全访问。</p><h1><span id="自定义https证书"><span id="inline-blue">自定义https证书</span></span></h1><p>创建自动生成https脚本gen-TLS.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/harbor</span><br><span class="line">vim gen-TLS.sh</span><br></pre></td></tr></table></figure><p>gen-TLS.sh内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在该目录下操作生成证书，正好供harbor.yml使用</span></span><br><span class="line">mkdir -p /usr/local/harbor/https</span><br><span class="line">cd /usr/local/harbor/https</span><br><span class="line"></span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 -subj &quot;/C=CN/ST=HuBei/L=HuBei/O=example/OU=Personal/CN=coship.harbor.com&quot; -key ca.key -out ca.crt</span><br><span class="line">openssl genrsa -out coship.harbor.com.key 4096</span><br><span class="line">openssl req -sha512 -new -subj &quot;/C=CN/ST=HuBei/L=HuBei/O=example/OU=Personal/CN=coship.harbor.com&quot; -key coship.harbor.com.key -out coship.harbor.com.csr</span><br><span class="line"></span><br><span class="line">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=coship.harbor.com</span><br><span class="line">DNS.2=harbor</span><br><span class="line">DNS.3=ks-allinone</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">openssl x509 -req -sha512 -days 3650 -extfile v3.ext -CA ca.crt -CAkey ca.key -CAcreateserial -in coship.harbor.com.csr -out coship.harbor.com.crt</span><br><span class="line">    </span><br><span class="line">openssl x509 -inform PEM -in coship.harbor.com.crt -out coship.harbor.com.cert</span><br><span class="line"></span><br><span class="line">cp coship.harbor.com.crt /etc/pki/ca-trust/source/anchors/coship.harbor.com.crt </span><br><span class="line"></span><br><span class="line">update-ca-trust</span><br></pre></td></tr></table></figure><p>coship.harbor.com域名对应harbor.yml配置文件内hostname属性，因为是自签名证书，harbor所在服务器需要配置harbor服务的域名解析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.9.216.14 coship.harbor.com&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><p>后续不管是windows端访问harbor管理页面，还是linux端推送和拉取镜像，都需要配置在各自的域名解析服务里面配置上harbor的ip和域名的映射关系。<br>windows端配置方法:<br>修改hosts文件，文件路径：C:\Windows\System32\drivers\etc\hosts，添加如下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.9.216.14 coship.harbor.com</span><br></pre></td></tr></table></figure><p>进入harbor所在主目录，创建证书存放路径https</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/harbor</span><br><span class="line">mkdir https</span><br></pre></td></tr></table></figure><p>修改harbor.yml配置文件中证书配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> https related config</span></span><br><span class="line">https:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> https port <span class="keyword">for</span> harbor, default is 443</span></span><br><span class="line">  port: 443</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The path of cert and key files <span class="keyword">for</span> nginx</span></span><br><span class="line">  certificate: /usr/local/harbor/https/coship.harbor.com.crt</span><br><span class="line">  private_key: /usr/local/harbor/https/coship.harbor.com.key</span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="built_in">enable</span> strong ssl ciphers (default: <span class="literal">false</span>)</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> strong_ssl_ciphers: <span class="literal">false</span></span></span><br></pre></td></tr></table></figure><p>执行证书生成脚本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/harbor</span><br><span class="line">chmod a+x *.sh</span><br><span class="line">./gen-TLS.sh</span><br></pre></td></tr></table></figure><p>将生成证书对应文件拷贝到Docker默认认证目录下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把这三个证书文件复制到docker默认认证目录下</span></span><br><span class="line">mkdir -p /etc/docker/certs.d/coship.harbor.com/</span><br><span class="line">cp coship.harbor.com.cert /etc/docker/certs.d/coship.harbor.com/</span><br><span class="line">cp coship.harbor.com.key /etc/docker/certs.d/coship.harbor.com/</span><br><span class="line">cp ca.crt /etc/docker/certs.d/coship.harbor.com/</span><br></pre></td></tr></table></figure><p>重新生成harbor配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/harbor</span><br><span class="line">./prepare</span><br></pre></td></tr></table></figure><p>完成上述步骤后需要重启harbor和docker服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/harbor</span><br><span class="line"><span class="meta">#</span><span class="bash">通过docker-compose编排工具调用harbor默认编排文件docker-compose.yml,在其他目录执行没有效果</span></span><br><span class="line">docker-compose down -v</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启docker服务</span></span><br><span class="line">systemctl restart docker.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启harbar服务</span></span><br><span class="line">cd /usr/local/harbor</span><br><span class="line">docker-compose up -d </span><br></pre></td></tr></table></figure><h1><span id="验证"><span id="inline-blue">验证</span></span></h1><p>将脚本生成的证书文件ca.crt上传到浏览器受信任的根证书机构下，重启浏览器，访问<a href="https://coship.harbor.com/">https://coship.harbor.com</a></p><p><img src="/images/docker/20250114/docker_20250114_003.png" alt="Dockerfile 远程安全连接"></p><p>推送镜像到harbor服务器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">拉取nginx官方镜像,默认标签版本latest</span></span><br><span class="line">docker pull nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">给镜像打tag</span></span><br><span class="line">docker tag nginx coship.harbor.com/library/nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">登录harbor</span></span><br><span class="line">docker login -u admin -p coshipOk698? coship.harbor.com</span><br><span class="line"><span class="meta">#</span><span class="bash">推送到harbor</span></span><br><span class="line">docker push coship.harbor.com/library/nginx</span><br></pre></td></tr></table></figure><p>推送镜像格式 harbor域名:端口/harbor项目名/镜像名:标签</p><p>上述的推送命令完整格式如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push coship.harbor.com:433/library/nginx:latest</span><br></pre></td></tr></table></figure><p>443是https默认访问端口，可以省略，latest为镜像默认标签，library为harbor仓库里面的默认项目</p><p>登录harbor,查看推送的镜像<br><img src="/images/docker/20250114/docker_20250114_004.png" alt="Dockerfile 远程安全连接"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/MySQL/blogs/Docker%E5%BC%80%E5%90%AF%E5%AE%89%E5%85%A8%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/MySQL/blogs/Docker%E5%BC%80%E5%90%AF%E5%AE%89%E5%85%A8%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/" class="post-title-link" itemprop="url">Docker开启安全远程连接</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-14 11:31:28" itemprop="dateCreated datePublished" datetime="2025-01-14T11:31:28+08:00">2025-01-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E5%88%9B%E5%BB%BA%E8%AF%81%E4%B9%A6span"><span id="inline-blue">创建证书</span></a></li><li><a href="#span-idinline-blueserver%E7%AB%AF%E9%85%8D%E7%BD%AEtls%E8%BF%9E%E6%8E%A5span"><span id="inline-blue">server端配置tls连接</span></a></li><li><a href="#span-idinline-blueclient%E7%AB%AF%E9%85%8D%E7%BD%AEtls%E8%BF%9E%E6%8E%A5span"><span id="inline-blue">client端配置tls连接</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Linux: CentOS Linux release 7.7.1908 (Core)<br>Docker：26.1.4<br>Docker compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>Docker swarm线上环境配置portainer容器管理服务，开启远程安全链接。</p><h1><span id="创建证书"><span id="inline-blue">创建证书</span></span></h1><p>创建证书生成脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/docker</span><br><span class="line">vim gen-TLS.sh</span><br></pre></td></tr></table></figure><p>脚本添加如下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">ip=&quot;10.9.216.12&quot;</span><br><span class="line">password=&quot;coshipOk698&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书生成位置</span></span><br><span class="line">dir=&quot;/etc/docker/certs&quot; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 证书有效期10年，单位是天</span></span><br><span class="line">validity_period=3650    </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果目录不存在则创建目录，否则删除重建</span></span><br><span class="line">if [ ! -d &quot;$dir&quot; ]; then</span><br><span class="line">  echo &quot;$dir 不存在，将创建目录&quot;</span><br><span class="line">  mkdir -p $dir</span><br><span class="line">else</span><br><span class="line">  echo &quot;$dir 存在，将删除并重建&quot;</span><br><span class="line">  rm -rf $dir</span><br><span class="line">  mkdir -p $dir</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd $dir || exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. 创建根证书 RSA 私钥</span></span><br><span class="line">openssl genrsa -aes256 -passout pass:&quot;$password&quot; -out ca-key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 创建 CA 证书</span></span><br><span class="line">openssl req -new -x509 -days $validity_period -key ca-key.pem -passin pass:&quot;$password&quot; -sha256 -out ca.pem -subj &quot;/C=NL/ST=./L=./O=./CN=$ip&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 创建服务端私钥</span></span><br><span class="line">openssl genrsa -out server-key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 创建服务端签名请求证书文件</span></span><br><span class="line">openssl req -subj &quot;/CN=$ip&quot; -sha256 -new -key server-key.pem -out server.csr</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建服务端扩展配置文件 extfile.cnf</span></span><br><span class="line">echo &quot;subjectAltName = IP:$ip,IP:0.0.0.0&quot; &gt; extfile.cnf</span><br><span class="line">echo &quot;extendedKeyUsage = serverAuth&quot; &gt;&gt; extfile.cnf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5. 创建签名生效的服务端证书文件</span></span><br><span class="line">openssl x509 -req -days $validity_period -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem -passin &quot;pass:$password&quot; -CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6. 创建客户端私钥</span></span><br><span class="line">openssl genrsa -out key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7. 创建客户端签名请求证书文件</span></span><br><span class="line">openssl req -subj &#x27;/CN=client&#x27; -new -key key.pem -out client.csr</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建客户端扩展配置文件 extfile-client.cnf</span></span><br><span class="line">echo &quot;extendedKeyUsage = clientAuth&quot; &gt; extfile-client.cnf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 8. 创建签名生效的客户端证书文件</span></span><br><span class="line">openssl x509 -req -days $validity_period -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem -passin &quot;pass:$password&quot; -CAcreateserial -out cert.pem -extfile extfile-client.cnf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除临时文件</span></span><br><span class="line">rm -f client.csr server.csr extfile.cnf extfile-client.cnf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置文件权限</span></span><br><span class="line">chmod 0400 ca-key.pem key.pem server-key.pem</span><br><span class="line">chmod 0444 ca.pem server-cert.pem cert.pem</span><br><span class="line"></span><br><span class="line">echo &quot;证书生成完成&quot;</span><br></pre></td></tr></table></figure><p>ip: 修改为docker服务的IP<br>password: 证书密码，自行设置<br>dir： 证书生成目录，执行生成脚本，dir目录会先清空，再生成证书，最好单独设置空文件目录</p><p>赋予脚本执行权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/docker </span><br><span class="line">chmod a+x *.sh</span><br></pre></td></tr></table></figure><p>执行证书生成命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/docker</span><br><span class="line">sh gen-TLS.sh</span><br></pre></td></tr></table></figure><p>最终生成证书文件主要使用ca.pem、server-key.pem、server-cert.pem,cert.pem、key.pem<br>将证书文件分类归档为server、client</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/docker/certs</span><br><span class="line">mkdir server </span><br><span class="line">mkdir client</span><br><span class="line">cp ca.pem server-key.pem、server-cert.pem  server</span><br><span class="line">cp ca.pem cert.pem、key.pem client</span><br></pre></td></tr></table></figure><h1><span id="server端配置tls连接"><span id="inline-blue">server端配置tls连接</span></span></h1><p>修改docker配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure><p>添加如下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/etc/docker/certs/server/ca.pem --tlscert=/etc/docker/certs/server/server-cert.pem --tlskey=/etc/docker/certs/server/server-key.pem  -H tcp://0.0.0.0:2375  -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><p>重启docker服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><h1><span id="client端配置tls连接"><span id="inline-blue">client端配置tls连接</span></span></h1><p>client端：<br>使用server文件夹内三个文件ca.pem、key.pem、cert.pem</p><p>client远程tls链接测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker --tlsverify --tlscacert=/etc/docker/certs/client/ca.pem --tlscert=/etc/docker/certs/client/cert.pem --tlskey=/etc/docker/certs/client/key.pem -H tcp://10.9.216.12:2375 version</span><br></pre></td></tr></table></figure><p><img src="/images/docker/20250114/docker_20250114_001.png" alt="Dockerfile 远程安全连接"></p><p>portainer配置tls</p><p><img src="/images/docker/20250114/docker_20250114_002.png" alt="Dockerfile 远程安全连接"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E7%A7%81%E6%9C%8Dhabor%E6%90%AD%E5%BB%BA/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E7%A7%81%E6%9C%8Dhabor%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">Docker私服habor搭建</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-10 17:32:21" itemprop="dateCreated datePublished" datetime="2025-01-10T17:32:21+08:00">2025-01-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>15k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blueharbor%E9%83%A8%E7%BD%B2span"><span id="inline-blue">harbor部署</span></a></li><li><a href="#span-idinline-blue%E9%AA%8C%E8%AF%81span"><span id="inline-blue">验证</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Linux: CentOS Linux release 7.7.1908 (Core)<br>Docker：26.1.4<br>Docker compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>docker swarm模式下实现基于docker-compose编排工具的多文件部署，但命令行的操作使得部署变得很麻烦，希望能够通过portainer+harbor实现容器的可视化管理。</p><h1><span id="harbor部署"><span id="inline-blue">harbor部署</span></span></h1><p>官网地址：<a href="https://goharbor.io/">https://goharbor.io/</a><br>github地址：<a href="https://github.com/goharbor/harbor/releases">https://github.com/goharbor/harbor/releases</a></p><p>下载对应的离线版本，上传至docker服务器/usr/local/habor目录下，执行解压</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf harbor-offline-installer-v2.12.1.tgz</span><br></pre></td></tr></table></figure><p>解压之后，赋予.sh脚本文件可执行权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x *.sh </span><br></pre></td></tr></table></figure><p>重命名配置文件，并修改配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv harbor.yml.tmpl  harbor.yml</span><br></pre></td></tr></table></figure><p>harbor.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration file of Harbor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The IP address or hostname to access admin UI and registry service.</span></span><br><span class="line"><span class="comment"># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span></span><br><span class="line"><span class="attr">hostname:</span> <span class="string">coship.harbor.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># http related config</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https related config</span></span><br><span class="line"><span class="attr">https:</span></span><br><span class="line">  <span class="comment"># https port for harbor, default is 443</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># The path of cert and key files for nginx</span></span><br><span class="line">  <span class="attr">certificate:</span> <span class="string">/usr/local/harbor/https/server.pem</span></span><br><span class="line">  <span class="attr">private_key:</span> <span class="string">/usr/local/harbor/https/server.key</span></span><br><span class="line">  <span class="comment"># enable strong ssl ciphers (default: false)</span></span><br><span class="line">  <span class="comment"># strong_ssl_ciphers: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Harbor will set ipv4 enabled only by default if this block is not configured</span></span><br><span class="line"><span class="comment"># # Otherwise, please uncomment this block to configure your own ip_family stacks</span></span><br><span class="line"><span class="comment"># ip_family:</span></span><br><span class="line"><span class="comment">#   # ipv6Enabled set to true if ipv6 is enabled in docker network, currently it affected the nginx related component</span></span><br><span class="line"><span class="comment">#   ipv6:</span></span><br><span class="line"><span class="comment">#     enabled: false</span></span><br><span class="line"><span class="comment">#   # ipv4Enabled set to true by default, currently it affected the nginx related component</span></span><br><span class="line"><span class="comment">#   ipv4:</span></span><br><span class="line"><span class="comment">#     enabled: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Uncomment following will enable tls communication between all harbor components</span></span><br><span class="line"><span class="comment"># internal_tls:</span></span><br><span class="line"><span class="comment">#   # set enabled to true means internal tls is enabled</span></span><br><span class="line"><span class="comment">#   enabled: true</span></span><br><span class="line"><span class="comment">#   # put your cert and key files on dir</span></span><br><span class="line"><span class="comment">#   dir: /etc/harbor/tls/internal</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment external_url if you want to enable external proxy</span></span><br><span class="line"><span class="comment"># And when it enabled the hostname will no longer used</span></span><br><span class="line"><span class="comment"># external_url: https://reg.mydomain.com:8433</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The initial password of Harbor admin</span></span><br><span class="line"><span class="comment"># It only works in first time to install harbor</span></span><br><span class="line"><span class="comment"># Remember Change the admin password from UI after launching Harbor.</span></span><br><span class="line"><span class="attr">harbor_admin_password:</span> <span class="string">coshipOk698?</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor DB configuration</span></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="comment"># The password for the user(&#x27;postgres&#x27; by default) of Harbor DB. Change this before any production use.</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">root123</span></span><br><span class="line">  <span class="comment"># The maximum number of connections in the idle connection pool. If it &lt;=0, no idle connections are retained.</span></span><br><span class="line">  <span class="attr">max_idle_conns:</span> <span class="number">100</span></span><br><span class="line">  <span class="comment"># The maximum number of open connections to the database. If it &lt;= 0, then there is no limit on the number of open connections.</span></span><br><span class="line">  <span class="comment"># <span class="doctag">Note:</span> the default number of connections is 1024 for postgres of harbor.</span></span><br><span class="line">  <span class="attr">max_open_conns:</span> <span class="number">900</span></span><br><span class="line">  <span class="comment"># The maximum amount of time a connection may be reused. Expired connections may be closed lazily before reuse. If it &lt;= 0, connections are not closed due to a connection&#x27;s age.</span></span><br><span class="line">  <span class="comment"># The value is a duration string. A duration string is a possibly signed sequence of decimal numbers, each with optional fraction and a unit suffix, such as &quot;300ms&quot;, &quot;-1.5h&quot; or &quot;2h45m&quot;. Valid time units are &quot;ns&quot;, &quot;us&quot; (or &quot;µs&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;.</span></span><br><span class="line">  <span class="attr">conn_max_lifetime:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># The maximum amount of time a connection may be idle. Expired connections may be closed lazily before reuse. If it &lt;= 0, connections are not closed due to a connection&#x27;s idle time.</span></span><br><span class="line">  <span class="comment"># The value is a duration string. A duration string is a possibly signed sequence of decimal numbers, each with optional fraction and a unit suffix, such as &quot;300ms&quot;, &quot;-1.5h&quot; or &quot;2h45m&quot;. Valid time units are &quot;ns&quot;, &quot;us&quot; (or &quot;µs&quot;), &quot;ms&quot;, &quot;s&quot;, &quot;m&quot;, &quot;h&quot;.</span></span><br><span class="line">  <span class="attr">conn_max_idle_time:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The default data volume</span></span><br><span class="line"><span class="attr">data_volume:</span> <span class="string">/data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor Storage settings by default is using /data dir on local filesystem</span></span><br><span class="line"><span class="comment"># Uncomment storage_service setting If you want to using external storage</span></span><br><span class="line"><span class="comment"># storage_service:</span></span><br><span class="line"><span class="comment">#   # ca_bundle is the path to the custom root ca certificate, which will be injected into the truststore</span></span><br><span class="line"><span class="comment">#   # of registry&#x27;s containers.  This is usually needed when the user hosts a internal storage with self signed certificate.</span></span><br><span class="line"><span class="comment">#   ca_bundle:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   # storage backend, default is filesystem, options include filesystem, azure, gcs, s3, swift and oss</span></span><br><span class="line"><span class="comment">#   # for more info about this configuration please refer https://distribution.github.io/distribution/about/configuration/</span></span><br><span class="line"><span class="comment">#   # and https://distribution.github.io/distribution/storage-drivers/</span></span><br><span class="line"><span class="comment">#   filesystem:</span></span><br><span class="line"><span class="comment">#     maxthreads: 100</span></span><br><span class="line"><span class="comment">#   # set disable to true when you want to disable registry redirect</span></span><br><span class="line"><span class="comment">#   redirect:</span></span><br><span class="line"><span class="comment">#     disable: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Trivy configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Trivy DB contains vulnerability information from NVD, Red Hat, and many other upstream vulnerability databases.</span></span><br><span class="line"><span class="comment"># It is downloaded by Trivy from the GitHub release page https://github.com/aquasecurity/trivy-db/releases and cached</span></span><br><span class="line"><span class="comment"># in the local file system. In addition, the database contains the update timestamp so Trivy can detect whether it</span></span><br><span class="line"><span class="comment"># should download a newer version from the Internet or use the cached one. Currently, the database is updated every</span></span><br><span class="line"><span class="comment"># 12 hours and published as a new release to GitHub.</span></span><br><span class="line"><span class="attr">trivy:</span></span><br><span class="line">  <span class="comment"># ignoreUnfixed The flag to display only fixed vulnerabilities</span></span><br><span class="line">  <span class="attr">ignore_unfixed:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># skipUpdate The flag to enable or disable Trivy DB downloads from GitHub</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># You might want to enable this flag in test or CI/CD environments to avoid GitHub rate limiting issues.</span></span><br><span class="line">  <span class="comment"># If the flag is enabled you have to download the `trivy-offline.tar.gz` archive manually, extract `trivy.db` and</span></span><br><span class="line">  <span class="comment"># `metadata.json` files and mount them in the `/home/scanner/.cache/trivy/db` path.</span></span><br><span class="line">  <span class="attr">skip_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># skipJavaDBUpdate If the flag is enabled you have to manually download the `trivy-java.db` file and mount it in the</span></span><br><span class="line">  <span class="comment"># `/home/scanner/.cache/trivy/java-db/trivy-java.db` path</span></span><br><span class="line">  <span class="attr">skip_java_db_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># The offline_scan option prevents Trivy from sending API requests to identify dependencies.</span></span><br><span class="line">  <span class="comment"># Scanning JAR files and pom.xml may require Internet access for better detection, but this option tries to avoid it.</span></span><br><span class="line">  <span class="comment"># For example, the offline mode will not try to resolve transitive dependencies in pom.xml when the dependency doesn&#x27;t</span></span><br><span class="line">  <span class="comment"># exist in the local repositories. It means a number of detected vulnerabilities might be fewer in offline mode.</span></span><br><span class="line">  <span class="comment"># It would work if all the dependencies are in local.</span></span><br><span class="line">  <span class="comment"># This option doesn&#x27;t affect DB download. You need to specify &quot;skip-update&quot; as well as &quot;offline-scan&quot; in an air-gapped environment.</span></span><br><span class="line">  <span class="attr">offline_scan:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Comma-separated list of what security issues to detect. Possible values are `vuln`, `config` and `secret`. Defaults to `vuln`.</span></span><br><span class="line">  <span class="attr">security_check:</span> <span class="string">vuln</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># insecure The flag to skip verifying registry certificate</span></span><br><span class="line">  <span class="attr">insecure:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># timeout The duration to wait for scan completion.</span></span><br><span class="line">  <span class="comment"># There is upper bound of 30 minutes defined in scan job. So if this `timeout` is larger than 30m0s, it will also timeout at 30m0s.</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">5m0s</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># github_token The GitHub access token to download Trivy DB</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Anonymous downloads from GitHub are subject to the limit of 60 requests per hour. Normally such rate limit is enough</span></span><br><span class="line">  <span class="comment"># for production operations. If, for any reason, it&#x27;s not enough, you could increase the rate limit to 5000</span></span><br><span class="line">  <span class="comment"># requests per hour by specifying the GitHub access token. For more details on GitHub rate limiting please consult</span></span><br><span class="line">  <span class="comment"># https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># You can create a GitHub token by following the instructions in</span></span><br><span class="line">  <span class="comment"># https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># github_token: xxx</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobservice:</span></span><br><span class="line">  <span class="comment"># Maximum number of job workers in job service</span></span><br><span class="line">  <span class="attr">max_job_workers:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># The jobLoggers backend name, only support &quot;STD_OUTPUT&quot;, &quot;FILE&quot; and/or &quot;DB&quot;</span></span><br><span class="line">  <span class="attr">job_loggers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">STD_OUTPUT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">FILE</span></span><br><span class="line">    <span class="comment"># - DB</span></span><br><span class="line">  <span class="comment"># The jobLogger sweeper duration (ignored if `jobLogger` is `stdout`)</span></span><br><span class="line">  <span class="attr">logger_sweeper_duration:</span> <span class="number">1</span> <span class="comment">#days</span></span><br><span class="line"></span><br><span class="line"><span class="attr">notification:</span></span><br><span class="line">  <span class="comment"># Maximum retry count for webhook job</span></span><br><span class="line">  <span class="attr">webhook_job_max_retry:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># HTTP client timeout for webhook job</span></span><br><span class="line">  <span class="attr">webhook_job_http_client_timeout:</span> <span class="number">3</span> <span class="comment">#seconds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log configurations</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="comment"># options are debug, info, warning, error, fatal</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">info</span></span><br><span class="line">  <span class="comment"># configs for logs in local storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="comment"># Log files are rotated log_rotate_count times before being removed. If count is 0, old versions are removed rather than rotated.</span></span><br><span class="line">    <span class="attr">rotate_count:</span> <span class="number">50</span></span><br><span class="line">    <span class="comment"># Log files are rotated only if they grow bigger than log_rotate_size bytes. If size is followed by k, the size is assumed to be in kilobytes.</span></span><br><span class="line">    <span class="comment"># If the M is used, the size is in megabytes, and if G is used, the size is in gigabytes. So size 100, size 100k, size 100M and size 100G</span></span><br><span class="line">    <span class="comment"># are all valid.</span></span><br><span class="line">    <span class="attr">rotate_size:</span> <span class="string">200M</span></span><br><span class="line">    <span class="comment"># The directory on your host that store log</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">/var/log/harbor</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Uncomment following lines to enable external syslog endpoint.</span></span><br><span class="line">  <span class="comment"># external_endpoint:</span></span><br><span class="line">  <span class="comment">#   # protocol used to transmit log to external endpoint, options is tcp or udp</span></span><br><span class="line">  <span class="comment">#   protocol: tcp</span></span><br><span class="line">  <span class="comment">#   # The host of external endpoint</span></span><br><span class="line">  <span class="comment">#   host: localhost</span></span><br><span class="line">  <span class="comment">#   # Port of external endpoint</span></span><br><span class="line">  <span class="comment">#   port: 5140</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#This attribute is for migrator to detect the version of the .cfg file, DO NOT MODIFY!</span></span><br><span class="line"><span class="attr">_version:</span> <span class="number">2.12</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment external_database if using external database.</span></span><br><span class="line"><span class="comment"># external_database:</span></span><br><span class="line"><span class="comment">#   harbor:</span></span><br><span class="line"><span class="comment">#     host: harbor_db_host</span></span><br><span class="line"><span class="comment">#     port: harbor_db_port</span></span><br><span class="line"><span class="comment">#     db_name: harbor_db_name</span></span><br><span class="line"><span class="comment">#     username: harbor_db_username</span></span><br><span class="line"><span class="comment">#     password: harbor_db_password</span></span><br><span class="line"><span class="comment">#     ssl_mode: disable</span></span><br><span class="line"><span class="comment">#     max_idle_conns: 2</span></span><br><span class="line"><span class="comment">#     max_open_conns: 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment redis if need to customize redis db</span></span><br><span class="line"><span class="comment"># redis:</span></span><br><span class="line"><span class="comment">#   # db_index 0 is for core, it&#x27;s unchangeable</span></span><br><span class="line"><span class="comment">#   # registry_db_index: 1</span></span><br><span class="line"><span class="comment">#   # jobservice_db_index: 2</span></span><br><span class="line"><span class="comment">#   # trivy_db_index: 5</span></span><br><span class="line"><span class="comment">#   # it&#x27;s optional, the db for harbor business misc, by default is 0, uncomment it if you want to change it.</span></span><br><span class="line"><span class="comment">#   # harbor_db_index: 6</span></span><br><span class="line"><span class="comment">#   # it&#x27;s optional, the db for harbor cache layer, by default is 0, uncomment it if you want to change it.</span></span><br><span class="line"><span class="comment">#   # cache_layer_db_index: 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment external_redis if using external Redis server</span></span><br><span class="line"><span class="comment"># external_redis:</span></span><br><span class="line"><span class="comment">#   # support redis, redis+sentinel</span></span><br><span class="line"><span class="comment">#   # host for redis: &lt;host_redis&gt;:&lt;port_redis&gt;</span></span><br><span class="line"><span class="comment">#   # host for redis+sentinel:</span></span><br><span class="line"><span class="comment">#   #  &lt;host_sentinel1&gt;:&lt;port_sentinel1&gt;,&lt;host_sentinel2&gt;:&lt;port_sentinel2&gt;,&lt;host_sentinel3&gt;:&lt;port_sentinel3&gt;</span></span><br><span class="line"><span class="comment">#   host: redis:6379</span></span><br><span class="line"><span class="comment">#   password: </span></span><br><span class="line"><span class="comment">#   # Redis AUTH command was extended in Redis 6, it is possible to use it in the two-arguments AUTH &lt;username&gt; &lt;password&gt; form.</span></span><br><span class="line"><span class="comment">#   # there&#x27;s a known issue when using external redis username ref:https://github.com/goharbor/harbor/issues/18892</span></span><br><span class="line"><span class="comment">#   # if you care about the image pull/push performance, please refer to this https://github.com/goharbor/harbor/wiki/Harbor-FAQs#external-redis-username-password-usage</span></span><br><span class="line"><span class="comment">#   # username:</span></span><br><span class="line"><span class="comment">#   # sentinel_master_set must be set to support redis+sentinel</span></span><br><span class="line"><span class="comment">#   #sentinel_master_set:</span></span><br><span class="line"><span class="comment">#   # db_index 0 is for core, it&#x27;s unchangeable</span></span><br><span class="line"><span class="comment">#   registry_db_index: 1</span></span><br><span class="line"><span class="comment">#   jobservice_db_index: 2</span></span><br><span class="line"><span class="comment">#   trivy_db_index: 5</span></span><br><span class="line"><span class="comment">#   idle_timeout_seconds: 30</span></span><br><span class="line"><span class="comment">#   # it&#x27;s optional, the db for harbor business misc, by default is 0, uncomment it if you want to change it.</span></span><br><span class="line"><span class="comment">#   # harbor_db_index: 6</span></span><br><span class="line"><span class="comment">#   # it&#x27;s optional, the db for harbor cache layer, by default is 0, uncomment it if you want to change it.</span></span><br><span class="line"><span class="comment">#   # cache_layer_db_index: 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment uaa for trusting the certificate of uaa instance that is hosted via self-signed cert.</span></span><br><span class="line"><span class="comment"># uaa:</span></span><br><span class="line"><span class="comment">#   ca_file: /path/to/ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global proxy</span></span><br><span class="line"><span class="comment"># Config http proxy for components, e.g. http://my.proxy.com:3128</span></span><br><span class="line"><span class="comment"># Components doesn&#x27;t need to connect to each others via http proxy.</span></span><br><span class="line"><span class="comment"># Remove component from `components` array if want disable proxy</span></span><br><span class="line"><span class="comment"># for it. If you want use proxy for replication, MUST enable proxy</span></span><br><span class="line"><span class="comment"># for core and jobservice, and set `http_proxy` and `https_proxy`.</span></span><br><span class="line"><span class="comment"># Add domain to the `no_proxy` field, when you want disable proxy</span></span><br><span class="line"><span class="comment"># for some special registry.</span></span><br><span class="line"><span class="attr">proxy:</span></span><br><span class="line">  <span class="attr">http_proxy:</span></span><br><span class="line">  <span class="attr">https_proxy:</span></span><br><span class="line">  <span class="attr">no_proxy:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">core</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">jobservice</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">trivy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># metric:</span></span><br><span class="line"><span class="comment">#   enabled: false</span></span><br><span class="line"><span class="comment">#   port: 9090</span></span><br><span class="line"><span class="comment">#   path: /metrics</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Trace related config</span></span><br><span class="line"><span class="comment"># only can enable one trace provider(jaeger or otel) at the same time,</span></span><br><span class="line"><span class="comment"># and when using jaeger as provider, can only enable it with agent mode or collector mode.</span></span><br><span class="line"><span class="comment"># if using jaeger collector mode, uncomment endpoint and uncomment username, password if needed</span></span><br><span class="line"><span class="comment"># if using jaeger agetn mode uncomment agent_host and agent_port</span></span><br><span class="line"><span class="comment"># trace:</span></span><br><span class="line"><span class="comment">#   enabled: true</span></span><br><span class="line"><span class="comment">#   # set sample_rate to 1 if you wanna sampling 100% of trace data; set 0.5 if you wanna sampling 50% of trace data, and so forth</span></span><br><span class="line"><span class="comment">#   sample_rate: 1</span></span><br><span class="line"><span class="comment">#   # # namespace used to differentiate different harbor services</span></span><br><span class="line"><span class="comment">#   # namespace:</span></span><br><span class="line"><span class="comment">#   # # attributes is a key value dict contains user defined attributes used to initialize trace provider</span></span><br><span class="line"><span class="comment">#   # attributes:</span></span><br><span class="line"><span class="comment">#   #   application: harbor</span></span><br><span class="line"><span class="comment">#   # # jaeger should be 1.26 or newer.</span></span><br><span class="line"><span class="comment">#   # jaeger:</span></span><br><span class="line"><span class="comment">#   #   endpoint: http://hostname:14268/api/traces</span></span><br><span class="line"><span class="comment">#   #   username:</span></span><br><span class="line"><span class="comment">#   #   password:</span></span><br><span class="line"><span class="comment">#   #   agent_host: hostname</span></span><br><span class="line"><span class="comment">#   #   # export trace data by jaeger.thrift in compact mode</span></span><br><span class="line"><span class="comment">#   #   agent_port: 6831</span></span><br><span class="line"><span class="comment">#   # otel:</span></span><br><span class="line"><span class="comment">#   #   endpoint: hostname:4318</span></span><br><span class="line"><span class="comment">#   #   url_path: /v1/traces</span></span><br><span class="line"><span class="comment">#   #   compression: false</span></span><br><span class="line"><span class="comment">#   #   insecure: true</span></span><br><span class="line"><span class="comment">#   #   # timeout is in seconds</span></span><br><span class="line"><span class="comment">#   #   timeout: 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable purge _upload directories</span></span><br><span class="line"><span class="attr">upload_purging:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># remove files in _upload directories which exist for a period of time, default is one week.</span></span><br><span class="line">  <span class="attr">age:</span> <span class="string">168h</span></span><br><span class="line">  <span class="comment"># the interval of the purge operations</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">24h</span></span><br><span class="line">  <span class="attr">dryrun:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cache layer configurations</span></span><br><span class="line"><span class="comment"># If this feature enabled, harbor will cache the resource</span></span><br><span class="line"><span class="comment"># `project/project_metadata/repository/artifact/manifest` in the redis</span></span><br><span class="line"><span class="comment"># which can especially help to improve the performance of high concurrent</span></span><br><span class="line"><span class="comment"># manifest pulling.</span></span><br><span class="line"><span class="comment"># NOTICE</span></span><br><span class="line"><span class="comment"># If you are deploying Harbor in HA mode, make sure that all the harbor</span></span><br><span class="line"><span class="comment"># instances have the same behaviour, all with caching enabled or disabled,</span></span><br><span class="line"><span class="comment"># otherwise it can lead to potential data inconsistency.</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="comment"># not enabled by default</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># keep cache for one day by default</span></span><br><span class="line">  <span class="attr">expire_hours:</span> <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Harbor core configurations</span></span><br><span class="line"><span class="comment"># Uncomment to enable the following harbor core related configuration items.</span></span><br><span class="line"><span class="comment"># core:</span></span><br><span class="line"><span class="comment">#   # The provider for updating project quota(usage), there are 2 options, redis or db,</span></span><br><span class="line"><span class="comment">#   # by default is implemented by db but you can switch the updation via redis which</span></span><br><span class="line"><span class="comment">#   # can improve the performance of high concurrent pushing to the same project,</span></span><br><span class="line"><span class="comment">#   # and reduce the database connections spike and occupies.</span></span><br><span class="line"><span class="comment">#   # By redis will bring up some delay for quota usage updation for display, so only</span></span><br><span class="line"><span class="comment">#   # suggest switch provider to redis if you were ran into the db connections spike around</span></span><br><span class="line"><span class="comment">#   # the scenario of high concurrent pushing to same project, no improvement for other scenes.</span></span><br><span class="line"><span class="comment">#   quota_update_provider: redis # Or db</span></span><br></pre></td></tr></table></figure><p>主要修改图片中标识三项内容：<br><img src="/images/docker/20250110/docker_20250110_001.png" alt="Dockerfile harbor"></p><p>hostname: 设置harbor服务的域名或者主机IP</p><p>https: 加密安全访问可以通过下面命令生成对应证书文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">coship.harbor.com/10.9.216.14</span></span><br><span class="line"><span class="meta">#</span><span class="bash">指定/home路径下生成certificate.jks证书，秘钥为coshipOk698</span></span><br><span class="line">keytool -genkey -alias photoframe  -keyalg RSA -keysize 2048 -validity 3650 -ext SAN=dns:coship.harbor.com,ip:10.9.216.14 -keystore /usr/local/harbor/https/certificate.jks -storepass coshipOk698 -dname &quot;CN=coship.harbor.com, OU=coship.harbor.com, O=coship.harbor.com, L=wuhan, ST=wuhan, C=cn&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">certificate.jks是键值对形式的证书，推荐转换为标准格式pkcs12</span></span><br><span class="line">keytool -importkeystore -srckeystore certificate.jks -destkeystore certificate.jks -deststoretype pkcs12</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将certificate.jks证书导出，certificate.jks已经是pkcs12格式</span></span><br><span class="line">keytool -export -trustcacerts -alias photoframe -file /usr/local/harbor/https/cas.crt -keystore /usr/local/harbor/https/certificate.jks -storepass coshipOk698</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将cas.crt格式转换为server.pem，方便nginx使用</span></span><br><span class="line">openssl x509 -inform der -in cas.crt -out server.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">提取密钥</span></span><br><span class="line">openssl pkcs12 -nocerts -nodes -in certificate.jks -out server.key</span><br></pre></td></tr></table></figure><p>harbor_admin_password: 默认登录后台管理admin用户密码</p><p>执行harbor服务安装命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure><p>harbor服务启动之后其实是由docker内部多个服务组成，通过docker ps命令可以看到对应的容器服务如下：<br><img src="/images/docker/20250110/docker_20250110_002.png" alt="Dockerfile harbor"></p><p>harbor内置docker-compose容器编排文件docker-compose.yml,服务器重启之后，harbor对应的容器服务启动失败，原因是容器之间的依赖关系没有设置，导致容器缺失对应的依赖启动失败，容器默认的重启策略restart: always<br>解决这一问题的办法是手动执行docker-compose命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">进入habor主目录</span></span><br><span class="line">cd /usr/local/habor</span><br><span class="line"><span class="meta">#</span><span class="bash">docker-compose.yml文件在harbor主目录下指定执行有效，或者不指定的情况下默认使用的也是docker-compose.yml</span></span><br><span class="line">docker-compose up -d docker-compose.yml</span><br></pre></td></tr></table></figure><p>为了解决重启失效的问题，可以将harbor注册为系统服务，并在启动时默认执行容器编排服务命令。</p><p>创建对应的系统服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/systemd/system/harbor.service</span><br></pre></td></tr></table></figure><p>服务内容添加如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Harbor service</span><br><span class="line">Requires=docker.service</span><br><span class="line">After=docker.service</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=always</span><br><span class="line">//改成你的harbor路径</span><br><span class="line">WorkingDirectory=/usr/local/harbor </span><br><span class="line">//改成你的docker-compost路径 </span><br><span class="line">ExecStart=/usr/local/bin/docker-compose up </span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>设置开机启动和启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable harbor.service</span><br><span class="line">sudo systemctl start harbor.service</span><br></pre></td></tr></table></figure><h1><span id="验证"><span id="inline-blue">验证</span></span></h1><p>访问后台管理：<a href="https://10.9.216.14/">https://10.9.216.14/</a><br><img src="/images/docker/20250110/docker_20250110_003.png" alt="Dockerfile harbor"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E5%85%AD)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E5%85%AD)/" class="post-title-link" itemprop="url">Docker部署微服务集群(六)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-10 16:41:06" itemprop="dateCreated datePublished" datetime="2025-01-10T16:41:06+08:00">2025-01-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>17k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>15 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-bluedocker-composeyml%E4%B9%8B%E9%97%B4%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1span"><span id="inline-blue">docker-compose.yml之间网络通信</span></a></li><li><a href="#span-idinline-bluedocker-swarn-baseymlspan"><span id="inline-blue">docker-swarn-base.yml</span></a></li><li><a href="#span-idinline-bluedocker-swarn-servicesymlspan"><span id="inline-blue">docker-swarn-services.yml</span></a></li><li><a href="#span-idinline-bluedocker-swarn-monitorymlspan"><span id="inline-blue">docker-swarn-monitor.yml</span></a></li><li><a href="#span-idinline-bluedocker-swarn-portainerymlspan"><span id="inline-blue">docker-swarn-portainer.yml</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Linux: CentOS Linux release 7.7.1908 (Core)<br>Docker：26.1.4<br>Docker compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>微服务集群通过docker-compose编排工具成功在docker swarm分布式集群环境下部署后，发现更新stack下的服务非常麻烦，更新多个服务经常需要重复执行命令，导致有时执行服务的批量更新命令，MySQL和elasticsearch容器的数据丢失。<br>所以将微服务和基础服务MySQL、redis、Elasticsearch以及监控服务sentinel、zipkin 等分成多个文件进行服务编排，这样在升级微服务或者数据库的情况下，不会对其他stack里面服务造成影响。</p><h1><span id="docker-composeyml之间网络通信"><span id="inline-blue">docker-compose.yml之间网络通信</span></span></h1><p>微服务集群服务拆分为多个文件进行部署，首先需要解决服务之间的网络互通问题</p><p>docker-swarm-base.yml基础服务定义网络</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base/docker-swarm-base.yml</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">front:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">some-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">some-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">overlay</span></span><br></pre></td></tr></table></figure><p>docker-swarm-services.yml微服务引用网络</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># service/docker-swarm-services.yml</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">api:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">base_some-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">base_some-net:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>docker-swarm-base.yml作为其他服务的基础依赖，定义微服务集群的网络，driver:overlay表明创建网络类型为层叠网络，这是docker swarm模式下，docker容器能够跨docker主机通信的关键。<br>docker-swarm-services.yml引用网络名称使用的是base_some-net，而不是some-net,原因是因为docker swarm模式下部署的服务最终生成的service服务名称会添加上部署stack的前缀，部署命令类似：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c docker-swarm-base-process.yml --resolve-image never base</span><br></pre></td></tr></table></figure><p>-c: 指定stack部署依赖的配置文件<br>–resolve-image：指定拉取镜像时是否校验当前系统和镜像的兼容性(镜像架构一般有windows/arm64/amd64)<br>|镜像架构|兼容系统|<br>|:—:|:—:|<br>|windows|windows|<br>|arm64|MAC|<br>|amd64|Lniux|</p><p>never: 不进行校验，加快镜像构建的速度<br>base是部署的stack名称，部署服务的集合</p><h1><span id="docker-swarn-baseyml"><span id="inline-blue">docker-swarn-base.yml</span></span></h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">photoframe-mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">3307</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/conf:/etc/mysql/conf.d</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/log:/var/mysql/log</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/data:/var/mysql/data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/db/init:/docker-entrypoint-initdb.d/:ro</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/db/sql:/opt/sql/:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">coship</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./nacos</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MODE:</span> <span class="string">standalone</span></span><br><span class="line">      <span class="attr">PREFER_HOST_MODE:</span> <span class="string">ip</span></span><br><span class="line">      <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="string">photoframe-mysql</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">coship</span></span><br><span class="line">      <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">      <span class="attr">JVM_XMS:</span> <span class="string">1g</span></span><br><span class="line">      <span class="attr">JVM_XMX:</span> <span class="string">1g</span></span><br><span class="line">      <span class="attr">JVM_XMN:</span> <span class="string">128m</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">120</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nacos/logs/:/home/nacos/logs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nacos/conf/:/home/nacos/conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">8848</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">8849</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9848</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9850</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9849</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9851</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./redis</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">6380</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./redis/conf:/etc/redis/</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-elasticsearch</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./elasticsearch</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># 开启内存锁定</span></span><br><span class="line">      <span class="attr">bootstrap.memory_lock:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">ES_JAVA_OPTS:</span> <span class="string">&quot;-Xms4g -Xmx4g&quot;</span></span><br><span class="line">      <span class="comment"># 指定单节点启动</span></span><br><span class="line">      <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="comment"># 取消内存相关限制 用于开启内存锁定</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/data:/usr/local/elasticsearch-8.8.0/data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/logs:/usr/local/elasticsearch-8.8.0/logs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/config:/usr/local/elasticsearch-8.8.0/config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/plugins:/usr/local/elasticsearch-8.8.0/plugins</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9200</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9201</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9300</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9301</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-rabbitmq:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-rabbitmq</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">5672</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">5673</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">15672</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">15673</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/data:/var/lib/rabbitmq</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/log:/var/log/rabbitmq</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/conf:/etc/rabbitmq</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">photoframe-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">overlay</span></span><br></pre></td></tr></table></figure><p>部署基础服务命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-base.yml所在目录,转换配置，提取.env文件定义的环境变量</span></span><br><span class="line">docker stack config -c docker-swarm-base.yml &gt; docker-swarm-base-process.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-base-process.yml所在目录,执行部署</span></span><br><span class="line">docker stack deploy -c docker-swarm-base-process.yml --resolve-image never photoframe-base</span><br></pre></td></tr></table></figure><h1><span id="docker-swarn-servicesyml"><span id="inline-blue">docker-swarn-services.yml</span></span></h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">photoframe-admin-log:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-admin-log</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-admin-log</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9021</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9023</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-admin-biz:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-admin-biz</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-admin-biz</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9020</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9022</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-api-app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-api-app</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-api-app</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9006</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9008</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-api-pad:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-api-pad</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-api-pad</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9007</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9009</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./photoframe/uploadPath:/home/photoframe/uploadPath</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-auth:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-auth</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-auth</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9003</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9004</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-quartz:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-quartz</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-quartz</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9060</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9061</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">dnsrr</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line">  <span class="attr">photoframe-gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-gateway</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-gateway</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9001</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9002</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-nacos:8848,photoframe-redis:6379,photoframe-admin-biz:9020,photoframe-admin-log:9021,photoframe-api-app:9006,photoframe-api-pad:9007,photoframe-auth:9003,photoframe-quartz:9060</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">120s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==service</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">photoframe-base_photoframe-net:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>部署微服务命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-services.yml所在目录,转换配置，提取.env文件定义的环境变量</span></span><br><span class="line">docker stack config -c docker-swarm-services.yml &gt; docker-swarm-services-process.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-services-process.yml所在目录,执行部署</span></span><br><span class="line">docker stack deploy -c docker-swarm-services-process.yml --resolve-image never photoframe-services</span><br></pre></td></tr></table></figure><h1><span id="docker-swarn-monitoryml"><span id="inline-blue">docker-swarn-monitor.yml</span></span></h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">photoframe-nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-nginx</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./nginx</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9090</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9091</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nginx/conf/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nginx/logs:/var/log/nginx</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-gateway:9001</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-sentinel:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-sentinel</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./sentinel</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">8180</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">8181</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./sentinel/logs:/root/logs</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-nacos:8848</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-zipkin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-zipkin</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./zipkin</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9411</span></span><br><span class="line">      <span class="attr">published:</span> <span class="number">9412</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-elasticsearch:9200</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line">  <span class="attr">photoframe-zipkin-dependencies:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">photoframe-zipkin-dependencies</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./zipkin-dependencies</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-elasticsearch:9200</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">rollback_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">        <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">photoframe-base_photoframe-net:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>部署监控服务命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-monitor.yml所在目录,转换配置，提取.env文件定义的环境变量</span></span><br><span class="line">docker stack config -c docker-swarm-monitor.yml &gt; docker-swarm-monitor-process.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-monitor-process.yml所在目录,执行部署</span></span><br><span class="line">docker stack deploy -c docker-swarm-monitor-process.yml --resolve-image never photoframe-monitor</span><br></pre></td></tr></table></figure><h1><span id="docker-swarn-portaineryml"><span id="inline-blue">docker-swarn-portainer.yml</span></span></h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">portainer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">portainer/portainer</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/docker/portainer/data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-base_photoframe-net</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">node.labels.role==base</span>  </span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">photoframe-base_photoframe-net:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>部署portainer容器管理服务命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-portainer.yml所在目录,转换配置，提取.env文件定义的环境变量</span></span><br><span class="line">docker stack config -c docker-swarm-portainer.yml &gt; docker-swarm-portainer-process.yml</span><br><span class="line"><span class="meta">#</span><span class="bash">/usr/<span class="built_in">local</span>/docker,docker-swarm-portainer-process.yml所在目录,执行部署</span></span><br><span class="line">docker stack deploy -c docker-swarm-portainer-process.yml --resolve-image never photoframe-portainer</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/MySQL/blogs/Linux%20shell%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/MySQL/blogs/Linux%20shell%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD/" class="post-title-link" itemprop="url">Linux shell脚本实现MySQL数据库备份</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2025-01-03 16:36:03" itemprop="dateCreated datePublished" datetime="2025-01-03T16:36:03+08:00">2025-01-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.5k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-bluemysqlbackupshspan"><span id="inline-blue">mysqlBackup.sh</span></a></li><li><a href="#span-idinline-bluecrontab%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1span"><span id="inline-blue">crontab定时任务</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><pre><code>Linux: CentOS Linux release 7.7.1908 (Core)
MySQL：5.7</code></pre><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>线上服务对应数据库没有做备份，担心故障会导致数据丢失和业务异常，所以使用shell脚本定时备份数据库。</p><h1><span id="mysqlbackupsh"><span id="inline-blue">mysqlBackup.sh</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置部分</span></span><br><span class="line">DB_USER=&quot;root&quot;</span><br><span class="line">DB_PASSWORD=&quot;coship&quot;</span><br><span class="line">DB_NAME_LOVEHOME=&quot;lovehome_xw&quot;</span><br><span class="line">DB_NAME_IHOME_ALBUM=&quot;ihome_album_xw&quot;</span><br><span class="line">BACKUP_DIR=&quot;/home/mysqldump/backup/&quot;</span><br><span class="line">DATE=$(date +%Y%m%d)</span><br><span class="line">BACKUP_SAVE_DAYS=7</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建备份目录（如果不存在）</span></span><br><span class="line">mkdir -p $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行备份lovehome_xw</span></span><br><span class="line">/home/mysql/bin/mysqldump -u$&#123;DB_USER&#125; -p$&#123;DB_PASSWORD&#125; $&#123;DB_NAME_LOVEHOME&#125;  --ignore-table=$&#123;DB_NAME_LOVEHOME&#125;.sys_log_api_his  --ignore-table=$&#123;DB_NAME_LOVEHOME&#125;.read_msg_record_his  --ignore-table=$&#123;DB_NAME_LOVEHOME&#125;.push_record_his &gt; $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/$&#123;DB_NAME_LOVEHOME&#125;_$&#123;DATE&#125;.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查lovehome_xw备份是否成功</span></span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">  echo &quot;Backup successful: $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/$&#123;DB_NAME_LOVEHOME&#125;_$&#123;DATE&#125;.sql&quot; &gt;&gt; $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/backup.log</span><br><span class="line">else</span><br><span class="line">  echo &quot;Backup failed for $&#123;DB_NAME_LOVEHOME&#125; at $&#123;DATE&#125;&quot; &gt;&gt; $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/backup.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行备份ihome_album_xw</span></span><br><span class="line">/home/mysql/bin/mysqldump -u$&#123;DB_USER&#125; -p$&#123;DB_PASSWORD&#125; $&#123;DB_NAME_IHOME_ALBUM&#125; &gt; $&#123;BACKUP_DIR&#125;$&#123;DATE&#125;/$&#123;DB_NAME_IHOME_ALBUM&#125;_$&#123;DATE&#125;.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查ihome_album_xw备份是否成功</span></span><br><span class="line">if [ $? -eq 0 ]; then</span><br><span class="line">  echo &quot;Backup successful: $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/$&#123;DB_NAME_IHOME_ALBUM&#125;_$&#123;DATE&#125;.sql&quot; &gt;&gt; $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/backup.log</span><br><span class="line">else</span><br><span class="line">  echo &quot;Backup failed for $&#123;DB_NAME_IHOME_ALBUM&#125; at $&#123;DATE&#125;&quot; &gt;&gt; $&#123;BACKUP_DIR&#125;/$&#123;DATE&#125;/backup.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cd $&#123;BACKUP_DIR&#125;</span><br><span class="line">rm -rf `find $&#123;BACKUP_DIR&#125;  -type d -mtime +$&#123;BACKUP_SAVE_DAYS&#125;` &gt;&gt; $&#123;BACKUP_DIR&#125;/backupClear.log</span><br><span class="line">echo &quot;删除$&#123;BACKUP_SAVE_DAYS&#125;天前的备份文件完成&quot; &gt;&gt; $&#123;BACKUP_DIR&#125;/backupClear.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mysqldump使用绝对路径，否则通过crontab系统定时任务支持脚本备份数据为空。<br>–ignore-table用于指定备份需要忽略的表项，忽略多个表的情况下指定多次。<br>BACKUP_SAVE_DAYS参数控制备份文件只保留7天以内。</p><h1><span id="crontab定时任务"><span id="inline-blue">crontab定时任务</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1  * * * cd /DB  &amp;&amp; sh mysqlBackup.sh /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>凌晨一点执行数据库备份脚本。</p><p>参考：</p><p><a href="https://liam.page/2016/06/19/best-match-using-find-and-crontab-to-removed-outdated-files/">https://liam.page/2016/06/19/best-match-using-find-and-crontab-to-removed-outdated-files/</a></p><p><a href="http://www.360doc.com/content/24/0701/12/83536423_1127581357.shtml">http://www.360doc.com/content/24/0701/12/83536423_1127581357.shtml</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/MySQL/blogs/MySQL%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%B7%A5%E5%85%B7mysql_random_data_load/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/MySQL/blogs/MySQL%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8D%AE%E5%B7%A5%E5%85%B7mysql_random_data_load/" class="post-title-link" itemprop="url">MySQL批量插入随机数据工具mysql_random_data_load</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-24 16:29:41" itemprop="dateCreated datePublished" datetime="2024-12-24T16:29:41+08:00">2024-12-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>630</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-bluemysql_random_data_load%E4%BB%8B%E7%BB%8Dspan"><span id="inline-blue">mysql_random_data_load介绍</span></a></li><li><a href="#span-idinline-blue%E4%B8%8B%E8%BD%BDspan"><span id="inline-blue">下载</span></a></li><li><a href="#span-idinline-blue%E8%A7%A3%E5%8E%8Bspan"><span id="inline-blue">解压</span></a></li><li><a href="#span-idinline-blue%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8Espan"><span id="inline-blue">使用说明</span></a></li><li><a href="#span-idinline-blue%E7%A4%BA%E4%BE%8Bspan"><span id="inline-blue">示例</span></a></li><li><a href="#span-idinline-blue%E9%AA%8C%E8%AF%81span"><span id="inline-blue">验证</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><pre><code>Linux: CentOS Linux release 7.7.1908 (Core)
MySQL：5.7</code></pre><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>线上业务需要测试MySQL归档工具pt-archiver在线删除表历史数据能力，使用自动随机生成数据工具mysql_random_data_load。</p><h1><span id="mysql_random_data_load介绍"><span id="inline-blue">mysql_random_data_load介绍</span></span></h1><p>github项目地址：<a href="https://github.com/Percona-Lab/mysql_random_data_load">https://github.com/Percona-Lab/mysql_random_data_load</a></p><h1><span id="下载"><span id="inline-blue">下载</span></span></h1><p><a href="https://github.com/Percona-Lab/mysql_random_data_load/releases">https://github.com/Percona-Lab/mysql_random_data_load/releases</a></p><p><img src="/images/mysql/20241224/mysql_20241224_001.png" alt="MySQL随机数据生成工具"><br>下载最新版本即可。</p><h1><span id="解压"><span id="inline-blue">解压</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mysql_random_data_load_0.1.12_Linux_x86_64.tar.gz</span><br></pre></td></tr></table></figure><h1><span id="使用说明"><span id="inline-blue">使用说明</span></span></h1><p><img src="/images/mysql/20241224/mysql_20241224_002.png" alt="MySQL随机数据生成工具"></p><h1><span id="示例"><span id="inline-blue">示例</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysql_random_data_load -h127.0.0.1 -uroot -p&#x27;coship&#x27; --max-threads=24  --bulk-size=3000 test t_title 5000000</span><br></pre></td></tr></table></figure><p>–max-threads=24: 使用24个线程来并行执行插入操作，提升数据加载的并发性。<br>–bulk-size=3000: 每次批量插入3000行数据减少插入频率降低连接开销。<br>test: 数据库名称<br>t_title：表名称<br>5000000： 生成数据总记录数</p><h1><span id="验证"><span id="inline-blue">验证</span></span></h1><p><img src="/images/mysql/20241224/mysql_20241224_003.png" alt="MySQL随机数据生成工具"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">Docker 容器执行定时任务</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-13 17:53:24" itemprop="dateCreated datePublished" datetime="2024-12-13T17:53:24+08:00">2024-12-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.4k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E5%AE%B9%E5%99%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E4%B8%8D%E9%80%80%E5%87%BA%E7%9A%84%E6%96%B9%E6%B3%95span"><span id="inline-blue">容器执行完不退出的方法</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Docker: 26.1.4<br>docker-compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>docker-compose 编排容器部署后发现zipkin-dependencies模块启动之后容器就退出了，因为zipkin-dependencies是基于spark执行的统计计算任务，导致后续在系统定时任务添加的定时脚本无法执行。</p><h1><span id="容器执行完不退出的方法"><span id="inline-blue">容器执行完不退出的方法</span></span></h1><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span>  exoplatform/ubuntu:<span class="number">20.04</span></span><br><span class="line"><span class="comment"># author</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> <span class="number">909754</span> &lt;<span class="number">18685129726</span>@<span class="number">163</span>.com&gt;</span><br><span class="line"><span class="comment">#拷贝jdk离线文件</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./jdk/jdk-11.0.18_linux-x64_bin.tar.gz /usr/<span class="built_in">local</span>/java</span></span><br><span class="line"><span class="comment">#设置jdk环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/usr/local/java/jdk-<span class="number">11.0</span>.<span class="number">18</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /home/photoframe/zipkin-dependencies &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt install -y cron &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt install -y vim</span></span><br><span class="line"><span class="comment"># 指定路径</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/photoframe/zipkin-dependencies</span></span><br><span class="line"><span class="comment">#环境变量设置</span></span><br><span class="line"><span class="keyword">ENV</span> STORAGE_TYPE=elasticsearch ES_HOSTS=http://photoframe-elasticsearch:<span class="number">9200</span></span><br><span class="line"><span class="comment">#拷贝启动脚本</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./sh/start.sh /home/photoframe/zipkin-dependencies/start.sh</span></span><br><span class="line"><span class="comment">#复制jar文件到路径</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./jar/zipkin-dependencies-3.0.0.jar /home/photoframe/zipkin-dependencies/zipkin-dependencies-3.0.0.jar</span></span><br><span class="line"><span class="comment">#复制容器依赖检测工具docker-compose-wait</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./docker-compose-wait/<span class="built_in">wait</span> /<span class="built_in">wait</span></span></span><br><span class="line"><span class="comment">#赋予执行权限</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> touch /etc/cron.d/crontab &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">&quot;*/1 * * * * root /bin/sh /home/photoframe/zipkin-dependencies/start.sh&quot;</span> &gt;&gt; /etc/cron.d/crontab &amp;&amp; \</span></span><br><span class="line"><span class="bash">    chmod a+x /home/photoframe/zipkin-dependencies/start.sh &amp;&amp; \</span></span><br><span class="line"><span class="bash">    chmod 0644 /etc/cron.d/crontab &amp;&amp; \</span></span><br><span class="line"><span class="bash">    touch /var/<span class="built_in">log</span>/cron.log &amp;&amp; \</span></span><br><span class="line"><span class="bash">    service cron restart &amp;&amp; \</span></span><br><span class="line"><span class="bash">    chmod a+x /<span class="built_in">wait</span></span></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">  cron  &amp;&amp; tail -f /var/<span class="built_in">log</span>/cron.log</span></span><br></pre></td></tr></table></figure><p>关键点在于tail -f /var/log/cron.log，表示一直监控定时任务的日志输出。这样可以保证容器执行完计算任务不退出容器，保持在线状态。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E4%BA%94)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E4%BA%94)/" class="post-title-link" itemprop="url">Docker部署微服务集群(五)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-13 15:38:45" itemprop="dateCreated datePublished" datetime="2024-12-13T15:38:45+08:00">2024-12-13</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>4k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blueswarm%E9%83%A8%E7%BD%B2span"><span id="inline-blue">swarm部署</span></a></li><li><a href="#span-idinline-blueswarm-%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BBspan"><span id="inline-blue">swarm 命令汇总</span></a></li><li><a href="#span-idinline-blueservice-%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BBspan"><span id="inline-blue">service 命令汇总</span></a></li><li><a href="#span-idinline-bluenode-%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BBspan"><span id="inline-blue">node 命令汇总</span></a></li><li><a href="#span-idinline-blue%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98span"><span id="inline-blue">部署过程中遇到的问题</span></a><ul><li><a href="#span-idinline-bluedocker-stack%E4%B8%8D%E6%94%AF%E6%8C%81%E7%9A%84%E5%91%BD%E4%BB%A4span"><span id="inline-blue">docker stack不支持的命令</span></a></li><li><a href="#span-idinline-blue%E7%BD%91%E5%85%B3%E8%AE%BF%E9%97%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%A4%B1%E8%B4%A5span"><span id="inline-blue">网关访问微服务失败</span></a></li></ul></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Docker: 26.1.4<br>docker-compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>基于docker-compose容器编排工具，实现容器在swarm集群环境下的分布式部署.</p><h1><span id="swarm部署"><span id="inline-blue">swarm部署</span></span></h1><p>初始化swarm集群环境下manager和worker节点<br>管理节点(指定网卡IP地址)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr=10.9.216.12</span><br></pre></td></tr></table></figure><p>上述命令初始化当前节点为管理节点，并生成worker节点加入swarm集群命令，类似如下(token以实际情况为准)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token SWMTKN-1-40mxvjntj01uoyi0rr93ztouf2d3nfc9fg7c6546wjb45sj7r4-bsa9siqzzeibs1egwdxzfvql6 10.9.216.12:2377</span><br></pre></td></tr></table></figure><p>查看swarm集群割接点信息(manage节点执行):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node ls</span><br></pre></td></tr></table></figure><p>为swarm节点增加角色标签base，用于docker-swarm.yml编排service根据node.labels.role=base将容器部署到指定标签的swarm节点<br>语法：<br>docker node update –label-add<key1>–label-add<key2>=<value><nodename><br>示例：</nodename></value></key2></key1></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node update  --label-add role=base stmxgrb0232cv7zn4gzf5r118</span><br></pre></td></tr></table></figure><p>描述：<br>将stmxgrb0232cv7zn4gzf5r118节点赋予role标签base(基础服务mysql、nacos、redis、elasticsearch、rabbitmq、zipkin)</p><p>为swarm节点增加角色标签service，用于docker-swarm.yml编排service根据node.labels.role=service将容器部署到指定的swarm节点<br>语法：<br>docker node update –label-add<key1>–label-add<key2>=<value><nodename><br>示例：</nodename></value></key2></key1></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node update  --label-add role=service 3ucz3fscdmxo36wy716thaga8</span><br></pre></td></tr></table></figure><p>描述：<br>将3ucz3fscdmxo36wy716thaga8节点赋予role标签service(微服务)</p><p>interface，用于docker-swarm.yml编排interface根据node.labels.role=interface将容器部署到指定的swarm节点<br>语法：<br>docker node update –label-add<key1>–label-add<key2>=<value><nodename><br>示例：</nodename></value></key2></key1></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node update  --label-add role=interface 3ucz3fscdmxo36wy716thaga7</span><br></pre></td></tr></table></figure><p>描述：<br>将3ucz3fscdmxo36wy716thaga7节点赋予role标签interface(接口)</p><p>容器集群部署之前需要在部署对应容器的的swarm节点生成自定义镜像</p><p>方式一(Dockerfile):<br>切换到对应模块Dockerfile文件所在路径执行构建命令：</p><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t photoframe-mysql .</span><br></pre></td></tr></table></figure><p>-t:指定生成镜像名，和docker-swarm.yml文件中的对应模块的service指定image参数一致<br>. :代表了构建镜像的上下文环境，当前路径</p><p>方式二(docker-swarm.yml):<br>示例:<br>swarm带有base标签节点构建基础服务镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-swarm.yml build photoframe-mysql photoframe-redis photoframe-nacos photoframe-elasticsearch photoframe-rabbitmq photoframe-sentinel photoframe-zipkin photoframe-zipkin-dependencies</span><br></pre></td></tr></table></figure><p>swarm带有service标签节点构建微服务镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-swarm.yml build photoframe-gateway photoframe-auth   photoframe-admin-biz photoframe-admin-log   photoframe-quartz photoframe-nginx</span><br></pre></td></tr></table></figure><p>swarm带有interface标签节点构建接口微服务镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-swarm.yml build photoframe-api-app  photoframe-api-pad</span><br></pre></td></tr></table></figure><p>部署服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker stack config --compose-file docker-swarm.yml &gt; docker-swarm-process.yml</span><br><span class="line">docker stack deploy --compose-file docker-swarm-process.yml --resolve-image never photoframe</span><br></pre></td></tr></table></figure><p>stack: swarm集群部署的命令<br>docker stack config: 转换docker-swarm.yml配置，将env_file引用环境变量重写(docker deploy 命令不支持默认读取.env文件定义的环境变量)<br>docker stack deploy: 部署swarm栈，使用转换后的配置文件docker-swarm-process.yml<br>-c: 指定部署服务使用的docker-compose 配置文件，名称可自定义<br>photoframe: docker stack创建的栈名称<br>docker升级为swarm集群后不能再使用docker-compose命令执行docker-compose up -d(只适用单机环境)命令部署服务，需要使用docker stack命令部署</p><p>批量更新服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service ls --format &#x27;&#123;&#123;.Name&#125;&#125;&#x27; | xargs -L1 docker service update --force</span><br></pre></td></tr></table></figure><h1><span id="swarm-命令汇总"><span id="inline-blue">swarm 命令汇总</span></span></h1><table><thead><tr><th align="center">命令</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">docker swarm init</td><td align="center">初始化一个 swarm 群集</td></tr><tr><td align="center">docker swarm join</td><td align="center">加入群集作为节点或管理器</td></tr><tr><td align="center">docker swarm join-token</td><td align="center">管理用于加入群集的令牌</td></tr><tr><td align="center">docker swarm leave</td><td align="center">离开 swarm 群集</td></tr><tr><td align="center">docker swarm unlock</td><td align="center">解锁 swarm 群集</td></tr><tr><td align="center">docker swarm unlock-key</td><td align="center">管理解锁钥匙</td></tr><tr><td align="center">docker swarm update</td><td align="center">更新 swarm 群集</td></tr></tbody></table><h1><span id="service-命令汇总"><span id="inline-blue">service 命令汇总</span></span></h1><table><thead><tr><th align="center">命令</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">docker node</td><td align="center">service ls</td></tr><tr><td align="center">docker node</td><td align="center">service ps</td></tr><tr><td align="center">docker node</td><td align="center">service inspect</td></tr><tr><td align="center">docker node</td><td align="center">service update</td></tr><tr><td align="center">docker node</td><td align="center">service rm</td></tr></tbody></table><h1><span id="node-命令汇总"><span id="inline-blue">node 命令汇总</span></span></h1><table><thead><tr><th align="center">命令</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">docker node demote</td><td align="center">从 swarm 群集管理器中降级一个或多个节点</td></tr><tr><td align="center">docker node promote</td><td align="center">将一个或多个节点推入到群集管理器中(也就是升级节点)</td></tr><tr><td align="center">docker node inspect</td><td align="center">显示一个或多个节点的详细信息</td></tr><tr><td align="center">docker node ls</td><td align="center">列出 swarm 群集中的节点</td></tr><tr><td align="center">docker node ps</td><td align="center">列出在一个或多个节点上运行的任务，默认为当前节点</td></tr><tr><td align="center">docker node rm</td><td align="center">从 swarm 群集删除一个或多个节点</td></tr><tr><td align="center">docker node update</td><td align="center">更新一个节点</td></tr></tbody></table><h1><span id="部署过程中遇到的问题"><span id="inline-blue">部署过程中遇到的问题</span></span></h1><h2><span id="docker-stack不支持的命令"><span id="inline-blue">docker stack不支持的命令</span></span></h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">build</span></span><br><span class="line"><span class="string">cgroup_parent</span></span><br><span class="line"><span class="string">container_name</span></span><br><span class="line"><span class="string">devices</span></span><br><span class="line"><span class="string">tmpfs</span></span><br><span class="line"><span class="string">external_links</span></span><br><span class="line"><span class="string">links</span></span><br><span class="line"><span class="string">network_mode</span></span><br><span class="line"><span class="string">restart</span></span><br><span class="line"><span class="string">security_opt</span></span><br><span class="line"><span class="string">stop_signal</span></span><br><span class="line"><span class="string">sysctls</span></span><br><span class="line"><span class="string">userns_mode</span></span><br></pre></td></tr></table></figure><h2><span id="网关访问微服务失败"><span id="inline-blue">网关访问微服务失败</span></span></h2><p>原因就是我们在docker-compose.yml中定义swarm服务发现的模式问题：<br>endpoint_mode：</p><pre><code>vip: 这个是默认的方案。即通过虚拟的IP对外暴露服务，客户端无法察觉有多少个节点提供服务，也不知道实际提供服务的IP和端口。

dnsrr：这个是DNS的轮询调度。客户端访问的时候，Docker会通过DNS列表返回对应的服务一系列IP地址，客户连接其中的一个。这种方式通常用于使用自己的负载均衡器，或者window和linux的混合应用。</code></pre><p>我们在定义网关的时候使用的是deploy.endpoint_mode=vip，这个是没问题的 ，但是在定义网关后面的<br>子服务的时候就需要使用deploy.endpoint_mode=dnsrr这个模式了，因为我们是个集群，每个子服务存在<br>好几个副本，在网关路由的时候是通过服务名称去发现子服务的，而vip是通过ip地址发现的，所以需要使用dnsrr模式<br>在服务使用deploy.endpoint_mode=dnsrr模式后不能使用如下方式暴露端口：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span> <span class="string">&quot;8080:8080&quot;</span></span><br></pre></td></tr></table></figure><p>需要这样定义：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9411</span></span><br><span class="line">  <span class="attr">published:</span> <span class="number">9411</span></span><br><span class="line">  <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">host</span></span><br></pre></td></tr></table></figure><p>mode:</p><p>ingress: 通过 Ingress 模式发布的服务，可以保证从 Swarm 集群内任一节点（即使没有运行服务的副本）都能访问该服务；以 Host 模式发布的服务只能通过运行服务副本的节点来访问。<br>host: 表示只有外部请求发送到运行了服务副本的节点才可以访问该服务。</p><p>下图展示两种模式的区别：<br><img src="/images/docker/20241213/Docker_docker_swarm_20241213_001.png" alt="Dockerfile docker-swarm"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E5%9B%9B)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E5%9B%9B)/" class="post-title-link" itemprop="url">Docker部署微服务集群(四)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-06 10:05:19" itemprop="dateCreated datePublished" datetime="2024-12-06T10:05:19+08:00">2024-12-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>13k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>12 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-bluedocker%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%E7%8E%AF%E5%A2%83span"><span id="inline-blue">docker构建上下文环境</span></a></li><li><a href="#span-idinline-blue%E6%8B%B7%E8%B4%9D%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87%E5%86%85%E5%AE%B9span"><span id="inline-blue">拷贝微服务镜像构建上下文内容</span></a></li><li><a href="#span-idinline-blue%E9%95%9C%E5%83%8F%E6%89%B9%E9%87%8F%E5%AF%BC%E5%87%BAspan"><span id="inline-blue">镜像批量导出</span></a></li><li><a href="#span-idinline-blue%E9%95%9C%E5%83%8F%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5span"><span id="inline-blue">镜像批量导入</span></a></li><li><a href="#span-idinline-blue%E8%87%AA%E5%8A%A8%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%ACspan"><span id="inline-blue">自动执行脚本</span></a></li><li><a href="#span-idinline-blue%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8Espan"><span id="inline-blue">使用说明</span></a></li><li><a href="#span-idinline-blue%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98span"><span id="inline-blue">部署过程中遇到的问题</span></a><ul><li><a href="#span-idinline-blue%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%E9%97%AE%E9%A2%98span"><span id="inline-blue">端口映射问题</span></a></li><li><a href="#span-idinline-blueelasticseach%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98span"><span id="inline-blue">Elasticseach权限问题</span></a></li><li><a href="#span-idinline-blue%E6%8E%A5%E5%8F%A3%E8%8E%B7%E5%8F%96%E9%AA%8C%E8%AF%81%E7%A0%81%E5%A4%B1%E8%B4%A5span"><span id="inline-blue">接口获取验证码失败</span></a></li><li><a href="#span-idinline-bluedepends_on%E5%AF%BC%E8%87%B4%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%BC%82%E5%B8%B8span"><span id="inline-blue">depends_on导致容器启动异常</span></a></li></ul></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Docker: 26.1.4<br>docker-compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>基于docker-compose容器编排工具，实现容器启动、停止、删除，镜像批量导入导出，微服务打包自动拷贝镜像构建上下文环境。</p><h1><span id="docker构建上下文环境"><span id="inline-blue">docker构建上下文环境</span></span></h1><p><img src="/images/docker/20241206/Docker_docker_compose_20241206_001.png" alt="Dockerfile docker-compose"></p><h1><span id="拷贝微服务镜像构建上下文内容"><span id="inline-blue">拷贝微服务镜像构建上下文内容</span></span></h1><p>copy.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制项目的文件到对应docker路径，便于一键生成镜像。</span></span><br><span class="line">usage() &#123;</span><br><span class="line">	echo &quot;Usage: sh copy.sh&quot;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> copy sql</span></span><br><span class="line">echo &quot;begin copy sql &quot;</span><br><span class="line">cp ../DB/MySQL/init/nacos_config.sql ./mysql/db/sql</span><br><span class="line">cp ../DB/MySQL/init/init_table.sql ./mysql/db/sql</span><br><span class="line">cp ../DB/MySQL/init/init_data.sql ./mysql/db/sql</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> copy html</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;begin copy html &quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -r ../photoframe-ui/dist/** ./nginx/html/dist</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> copy jar</span></span><br><span class="line">echo &quot;begin copy photoframe-gateway&quot;</span><br><span class="line">cp ../photoframe-gateway/target/photoframe-gateway.jar ./photoframe/photoframe-gateway/jar</span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-auth&quot;</span><br><span class="line">cp ../photoframe-auth/target/photoframe-auth.jar ./photoframe/photoframe-auth/jar</span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-admin-biz&quot;</span><br><span class="line">cp ../photoframe-admin/photoframe-admin-biz/target/photoframe-admin-biz.jar  ./photoframe/photoframe-admin-biz/jar</span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-admin-log&quot;</span><br><span class="line">cp ../photoframe-admin/photoframe-admin-log/target/photoframe-admin-log.jar  ./photoframe/photoframe-admin-log/jar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-api-app&quot;</span><br><span class="line">cp ../photoframe-api/photoframe-api-app/target/photoframe-api-app.jar ./photoframe/photoframe-api-app/jar</span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-api-pad&quot;</span><br><span class="line">cp ../photoframe-api/photoframe-api-pad/target/photoframe-api-pad.jar ./photoframe/photoframe-api-pad/jar</span><br><span class="line"></span><br><span class="line">echo &quot;begin copy photoframe-quartz&quot;</span><br><span class="line">cp ../photoframe-quartz/target/photoframe-quartz.jar ./photoframe/photoframe-quartz/jar</span><br></pre></td></tr></table></figure><p>作用：<br>拷贝MySQL数据库初始化脚本到MySQL镜像构建上下文环境<br>拷贝前端UI到nginx镜像构建上下文环境<br>拷贝微服务打包生成的jar包到对应镜像构建上下文环境</p><p>windows环境执行copy.sh需要git环境支持</p><h1><span id="镜像批量导出"><span id="inline-blue">镜像批量导出</span></span></h1><p>export.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">rm -rf  images</span><br><span class="line">rm -rf tarname.txt</span><br><span class="line">docker images &gt; images.txt</span><br><span class="line">awk &#x27;&#123;print $1&#125;&#x27; images.txt &gt; REPOSITORY.txt</span><br><span class="line">sed -i &#x27;1d&#x27; REPOSITORY.txt</span><br><span class="line">mkdir images</span><br><span class="line">touch tarname.txt</span><br><span class="line">while read LINE</span><br><span class="line">do</span><br><span class="line">docker save $LINE &gt; ./images/$&#123;LINE//\//_&#125;.tar</span><br><span class="line">echo &quot;$&#123;LINE//\//_&#125;.tar&quot; &gt;&gt; tarname.txt</span><br><span class="line">done &lt; REPOSITORY.txt</span><br><span class="line">rm -rf images.txt REPOSITORY.txt</span><br><span class="line">cp import.sh ./images/</span><br><span class="line">echo &quot;images export finish&quot;</span><br></pre></td></tr></table></figure><p>批量导出docker环境下的镜像到当前目录images文件夹下</p><h1><span id="镜像批量导入"><span id="inline-blue">镜像批量导入</span></span></h1><p>import.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">while read LINE</span><br><span class="line">do</span><br><span class="line">docker  load -i ./images/$LINE</span><br><span class="line">echo ok</span><br><span class="line">done &lt; tarname.txt</span><br><span class="line">echo finish</span><br></pre></td></tr></table></figure><p>导入当前目录下images文件夹下的镜像</p><h1><span id="自动执行脚本"><span id="inline-blue">自动执行脚本</span></span></h1><p>run.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用说明，用来提示输入参数</span></span><br><span class="line">usage()</span><br><span class="line">&#123;</span><br><span class="line">	echo &quot;Usage: sh run.sh [port|base|modules|zipkin|stop|stop_base|stop_modules|stop_zipkin|rm|rm_base|rm_modules|rm_zipkin]&quot;</span><br><span class="line">	echo &quot; 启动基础服务(mysql、elasticsearch、redis、rabbitmq、nacos): sh run.sh base &quot;</span><br><span class="line">	echo &quot; 启动微服务: sh run.sh modules &quot;</span><br><span class="line">	echo &quot; 停止所有docker服务: sh run.sh stop &quot;</span><br><span class="line">	exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启所需端口</span></span><br><span class="line">port()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">mysql</span></span><br><span class="line">	firewall-cmd --add-port=3306/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">nacos</span></span><br><span class="line">	firewall-cmd --add-port=8848/tcp --permanent</span><br><span class="line">	firewall-cmd --add-port=8849/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">elasticsearch</span></span><br><span class="line">	firewall-cmd --add-port=9200/tcp --permanent</span><br><span class="line">	firewall-cmd --add-port=9300/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">zipkin</span></span><br><span class="line">	firewall-cmd --add-port=9411/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">sentinel</span></span><br><span class="line">	firewall-cmd --add-port=8180/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">rabbitmq</span></span><br><span class="line">	firewall-cmd --add-port=5672/tcp --permanent</span><br><span class="line">	firewall-cmd --add-port=15672/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">redis</span></span><br><span class="line">	firewall-cmd --add-port=6379/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-admin-biz</span></span><br><span class="line">	firewall-cmd --add-port=9020/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-admin-log</span></span><br><span class="line">	firewall-cmd --add-port=9021/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-api-app</span></span><br><span class="line">	firewall-cmd --add-port=9006/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-api-pad</span></span><br><span class="line">	firewall-cmd --add-port=9007/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-auth</span></span><br><span class="line">	firewall-cmd --add-port=9003/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">photoframe-gateway</span></span><br><span class="line">	firewall-cmd --add-port=9001/tcp --permanent</span><br><span class="line"><span class="meta">	#</span><span class="bash">nginx</span></span><br><span class="line">	firewall-cmd --add-port=8080/tcp --permanent</span><br><span class="line">	service firewalld restart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动基础环境（必须）</span></span><br><span class="line">base()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;启动基础服务容器(photoframe-mysql、photoframe-redis、photoframe-nacos、photoframe-elasticsearch、photoframe-rabbitmq)&quot;</span><br><span class="line">	docker-compose up -d photoframe-mysql photoframe-redis photoframe-nacos photoframe-elasticsearch photoframe-rabbitmq</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动程序模块（必须）</span></span><br><span class="line">modules()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;启动微服务模块容器&quot;</span><br><span class="line">	docker-compose up -d  photoframe-gateway photoframe-auth  photoframe-api-app  photoframe-api-pad photoframe-admin-biz photoframe-admin-log   photoframe-quartz photoframe-nginx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动链路追踪（可选）</span></span><br><span class="line">zipkin()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;启动zipkin链路追踪容器&quot;</span><br><span class="line">	docker-compose up -d photoframe-zipkin photoframe-zipkin-dependencies</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭所有环境/模块</span></span><br><span class="line">stop()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;停止所有Docker容器&quot;</span><br><span class="line">	docker-compose stop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭基础服务</span></span><br><span class="line">stop_base()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;停止基础服务容器(photoframe-mysql、photoframe-redis、photoframe-nacos、photoframe-elasticsearch、photoframe-rabbitmq)&quot;</span><br><span class="line">	docker-compose stop photoframe-mysql photoframe-redis photoframe-nacos photoframe-elasticsearch photoframe-rabbitmq</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭微服务模块</span></span><br><span class="line">stop_modules()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;停止微服务容器&quot;</span><br><span class="line">	docker-compose stop photoframe-gateway photoframe-auth  photoframe-api-app  photoframe-api-pad photoframe-admin-biz photoframe-admin-log   photoframe-quartz photoframe-nginx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭zipkin</span></span><br><span class="line">stop_modules()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;停止zipkin&quot;</span><br><span class="line">	docker-compose stop photoframe-zipkin photoframe-zipkin-dependencies</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除所有环境/模块</span></span><br><span class="line">rm()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;删除所有容器&quot;</span><br><span class="line">	docker-compose rm</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除基础容器</span></span><br><span class="line">rm_base()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;删除基础容器&quot;</span><br><span class="line">	docker-compose rm photoframe-mysql photoframe-redis photoframe-nacos photoframe-elasticsearch photoframe-rabbitmq</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除微服务容器</span></span><br><span class="line">rm_modules()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;删除微服务容器&quot;</span><br><span class="line">	docker-compose rm photoframe-gateway photoframe-auth  photoframe-api-app  photoframe-api-pad photoframe-admin-biz photoframe-admin-log   photoframe-quartz photoframe-nginx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除zipkin容器</span></span><br><span class="line">stop_zipkin()</span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;删除zipkin容器&quot;</span><br><span class="line">	docker-compose stop photoframe-zipkin photoframe-zipkin-dependencies</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据输入参数，选择执行对应方法，不输入则执行使用说明</span></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">&quot;port&quot;)</span><br><span class="line">	port</span><br><span class="line">;;</span><br><span class="line">&quot;base&quot;)</span><br><span class="line">	base</span><br><span class="line">;;</span><br><span class="line">&quot;modules&quot;)</span><br><span class="line">	modules</span><br><span class="line">;;</span><br><span class="line">&quot;zipkin&quot;)</span><br><span class="line">	zipkin</span><br><span class="line">;;</span><br><span class="line">&quot;stop&quot;)</span><br><span class="line">	stop</span><br><span class="line">;;</span><br><span class="line">&quot;stop_base&quot;)</span><br><span class="line">	stop_base</span><br><span class="line">;;</span><br><span class="line">&quot;stop_modules&quot;)</span><br><span class="line">	stop_modules</span><br><span class="line">;;</span><br><span class="line">&quot;stop_zipkin&quot;)</span><br><span class="line">	stop_zipkin</span><br><span class="line">;;</span><br><span class="line">&quot;rm&quot;)</span><br><span class="line">	rm</span><br><span class="line">;;</span><br><span class="line">&quot;rm_base&quot;)</span><br><span class="line">	rm_base</span><br><span class="line">;;</span><br><span class="line">&quot;rm_modules&quot;)</span><br><span class="line">	rm_modules</span><br><span class="line">;;</span><br><span class="line">&quot;rm_zipkin&quot;)</span><br><span class="line">	rm_zipkin</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">	usage</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><h1><span id="使用说明"><span id="inline-blue">使用说明</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">各模块jar包拷贝至对应docker环境目录(idea terminal需要配置git bash工具)</span><br><span class="line">sh copy.sh</span><br><span class="line"></span><br><span class="line">docker基础环境启动(mysql、redis、nacos)</span><br><span class="line">sh run.sh base</span><br><span class="line"></span><br><span class="line">docker项目核心环境启动(gateway、auth、admin、admin-log、quartz、api-app、api-pad)</span><br><span class="line">sh run.sh modules</span><br><span class="line"></span><br><span class="line">docker镜像批量导出</span><br><span class="line">sh export.sh</span><br><span class="line"></span><br><span class="line">docker镜像批量导入</span><br><span class="line">sh import.sh</span><br></pre></td></tr></table></figure><h1><span id="部署过程中遇到的问题"><span id="inline-blue">部署过程中遇到的问题</span></span></h1><h2><span id="端口映射问题"><span id="inline-blue">端口映射问题</span></span></h2><p>容器端口映射配置需要使用双引号，如下所示：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br></pre></td></tr></table></figure><h2><span id="elasticseach权限问题"><span id="inline-blue">Elasticseach权限问题</span></span></h2><p>Elasticsearch容器启动提示es.log not found ,没有对应的写入权限。</p><p>在Dockerfile里面创建对应的es用户，创建对应的日志目录，并且赋予了可读可写权限之外，docker-compose容器编排也加入了对应的权限赋予操作</p><p>Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="comment">#维护者</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> <span class="number">909754</span> &lt;<span class="number">18685129726</span>@<span class="number">163</span>.com&gt;</span><br><span class="line"><span class="comment">#拷贝安装包、创建elasticsearch用户elasticsearch、elasticsearch用户权限设置</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./tar/elasticsearch-8.8.0-linux-x86_64.tar.gz /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span> &amp;&amp; tar -zxvf elasticsearch-8.8.0-linux-x86_64.tar.gz &amp;&amp;  \</span></span><br><span class="line"><span class="bash">rm -f elasticsearch-8.8.0-linux-x86_64.tar.gz &amp;&amp; \</span></span><br><span class="line"><span class="bash">useradd es  &amp;&amp; \</span></span><br><span class="line"><span class="bash">chown -R es:es /usr/<span class="built_in">local</span>/elasticsearch-8.8.0 &amp;&amp; \</span></span><br><span class="line"><span class="bash">chmod -R 777  /usr/<span class="built_in">local</span>/elasticsearch-8.8.0</span></span><br><span class="line"><span class="comment">#拷贝配置文件</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./config/ /usr/<span class="built_in">local</span>/elasticsearch-8.8.0/config/</span></span><br><span class="line"><span class="comment">#elasticsearch</span></span><br><span class="line"><span class="keyword">USER</span> es</span><br><span class="line"><span class="comment">#WORKDIR指令用于指定容器的一个目录， 容器启动时执行的命令会在该目录下执行</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/<span class="built_in">local</span>/elasticsearch-8.8.0</span></span><br><span class="line"><span class="comment">#挂载匿名卷</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">&quot;/usr/local/elasticsearch-8.8.0/data&quot;</span>,<span class="string">&quot;/usr/local/elasticsearch-8.8.0/config&quot;</span>,<span class="string">&quot;/usr/local/elasticsearch-8.8.0/logs&quot;</span>]</span></span><br><span class="line"><span class="comment">#CMD用于设置默认执行的命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/usr/local/elasticsearch-8.8.0/bin/elasticsearch&quot;</span>]</span></span><br><span class="line"><span class="comment">#暴露服务端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">9200</span> <span class="number">9300</span></span><br></pre></td></tr></table></figure><p>docker-compose.yml 对应服务定义如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">photoframe-elasticsearch:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">photoframe-elasticsearch</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">./elasticsearch</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">  <span class="comment"># 开启内存锁定</span></span><br><span class="line">    <span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ES_JAVA_OPTS:</span> <span class="string">&quot;-Xms4g -Xmx4g&quot;</span></span><br><span class="line">  <span class="comment"># 指定单节点启动</span></span><br><span class="line">    <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">  <span class="attr">ulimits:</span></span><br><span class="line">    <span class="comment"># 取消内存相关限制 用于开启内存锁定</span></span><br><span class="line">    <span class="attr">memlock:</span></span><br><span class="line">      <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">      <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./elasticsearch/data:/usr/local/elasticsearch-8.8.0/data</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./elasticsearch/logs:/usr/local/elasticsearch-8.8.0/logs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./elasticsearch/config:/usr/local/elasticsearch-8.8.0/config</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./elasticsearch/plugins:/usr/local/elasticsearch-8.8.0/plugins</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;9300:9300&quot;</span></span><br></pre></td></tr></table></figure><p>最后发现挂载的宿主机目录也需要赋予读写权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R es:es /usr/local/docker/elasticsearch</span><br><span class="line">chmod -R 777  /usr/local/docker/elasticsearch</span><br></pre></td></tr></table></figure><h2><span id="接口获取验证码失败"><span id="inline-blue">接口获取验证码失败</span></span></h2><p>报错信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class="line">        at sun.awt.FontConfiguration.getVersion(FontConfiguration.java:1264)</span><br><span class="line">        at sun.awt.FontConfiguration.readFontConfigFile(FontConfiguration.java:219)</span><br><span class="line">        at sun.awt.FontConfiguration.init(FontConfiguration.java:107)</span><br><span class="line">        at sun.awt.X11FontManager.createFontConfiguration(X11FontManager.java:776)</span><br><span class="line">        at sun.font.SunFontManager$2.run(SunFontManager.java:431)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at sun.font.SunFontManager.&lt;init&gt;(SunFontManager.java:376)</span><br><span class="line">        at sun.awt.X11FontManager.&lt;init&gt;(X11FontManager.java:57)</span><br><span class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">        at java.lang.Class.newInstance(Class.java:442)</span><br><span class="line">        at sun.font.FontManagerFactory$1.run(FontManagerFactory.java:83)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at sun.font.FontManagerFactory.getInstance(FontManagerFactory.java:74)</span><br><span class="line">        at java.awt.Font.&lt;init&gt;(Font.java:614)</span><br><span class="line">        at java.awt.Font.createFont(Font.java:1056)</span><br><span class="line">        at Main$.delayedEndpoint$Main$1(Main.scala:32)</span><br><span class="line">        at Main$delayedInit$body.apply(Main.scala:11)</span><br><span class="line">        at scala.Function0$class.apply$mcV$sp(Function0.scala:40)</span><br><span class="line">        at scala.runtime.AbstractFunction0.apply$mcV$sp(AbstractFunction0.scala:12)</span><br><span class="line">        at scala.App$$anonfun$main$1.apply(App.scala:76)</span><br><span class="line">        at scala.App$$anonfun$main$1.apply(App.scala:76)</span><br><span class="line">        at scala.collection.immutable.List.foreach(List.scala:381)</span><br><span class="line">        at scala.collection.generic.TraversableForwarder$class.foreach(TraversableForwarder.scala:35)</span><br><span class="line">        at scala.App$class.main(App.scala:76)</span><br><span class="line">        at Main$.main(Main.scala:11)</span><br><span class="line">        at Main.main(Main.scala)</span><br></pre></td></tr></table></figure><p>原因是因为使用的java8精简基础镜像缺失相应的依赖，更改基础镜像即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--- FROM openjdk:8-jre-alpine</span><br><span class="line">+++ FROM openjdk:8-jre</span><br></pre></td></tr></table></figure><h2><span id="depends_on导致容器启动异常"><span id="inline-blue">depends_on导致容器启动异常</span></span></h2><p>depends_on配置项控制容器的启动顺序，只能保证容器启动顺序，不能实现被依赖容器服务启动完成的情况下再去启动相应的服务，导致加载异常，naocs依赖mysql,但不能保证MySQL服务可用的情况下去启动nacos,导致启动异常。</p><p>容器的依赖改用docker-compose-wait，实现容器间的心跳检测</p><p>Dockerfile文件加入docker-compose-wait支持：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> nacos/nacos-server:v2.<span class="number">1.1</span></span><br><span class="line"><span class="comment"># author</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> <span class="number">909754</span> &lt;<span class="number">18685129726</span>@<span class="number">163</span>.com&gt;</span><br><span class="line"><span class="comment"># 挂载目录</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /home/nacos</span></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /home/nacos</span></span><br><span class="line"><span class="comment"># 指定路径</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/nacos</span></span><br><span class="line"><span class="comment">#复制启动脚本</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./bin/docker-startup.sh /bin/docker-startup.sh</span></span><br><span class="line"><span class="comment">#赋予初始化脚本执行权限</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;/bin/docker-startup.sh&quot;</span>]</span></span><br><span class="line"><span class="comment">#复制容器依赖检测工具docker-compose-wait</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./docker-compose-wait/<span class="built_in">wait</span> /<span class="built_in">wait</span></span></span><br><span class="line"><span class="comment">#赋予检测脚本执行权限</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> [<span class="string">&quot;chmod&quot;</span>, <span class="string">&quot;+x&quot;</span>, <span class="string">&quot;/wait&quot;</span>]</span></span><br><span class="line"><span class="comment"># 复制application.properties文件到路径</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./conf/application.properties /home/nacos/conf/application.properties</span></span><br><span class="line"><span class="comment"># 复制nacos-logback.xml文件到路径</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./conf/nacos-logback.xml /home/nacos/conf/nacos-logback.xml</span></span><br><span class="line"><span class="comment">#初始化命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> /<span class="built_in">wait</span> &amp;&amp; bin/docker-startup.sh</span></span><br></pre></td></tr></table></figure><p>docker-compose-wait下载地址：<a href="https://github.com/ufoscout/docker-compose-wait/releases">https://github.com/ufoscout/docker-compose-wait/releases</a></p><p>docker-compose.yml编排工具加入对应的环境变量WAIT_HOSTS、WAIT_TIMEOUT</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">photoframe-nacos:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">photoframe-nacos</span></span><br><span class="line">  <span class="attr">env_file:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">./nacos</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">    <span class="attr">MODE:</span> <span class="string">standalone</span></span><br><span class="line">    <span class="attr">PREFER_HOST_MODE:</span> <span class="string">ip</span></span><br><span class="line">    <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">coship</span></span><br><span class="line">    <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">    <span class="attr">JVM_XMS:</span> <span class="string">1g</span></span><br><span class="line">    <span class="attr">JVM_XMX:</span> <span class="string">1g</span></span><br><span class="line">    <span class="attr">JVM_XMN:</span> <span class="string">128m</span></span><br><span class="line">    <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306</span></span><br><span class="line">    <span class="attr">WAIT_TIMEOUT:</span> <span class="number">120</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./nacos/logs/:/home/nacos/logs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./nacos/conf/:/home/nacos/conf</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">8848</span></span><br><span class="line">    <span class="attr">published:</span> <span class="number">8848</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9848</span></span><br><span class="line">    <span class="attr">published:</span> <span class="number">9848</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">target:</span> <span class="number">9849</span></span><br><span class="line">    <span class="attr">published:</span> <span class="number">9849</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">tcp</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">host</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">    <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">    <span class="attr">restart_policy:</span></span><br><span class="line">      <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">3s</span></span><br><span class="line">      <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">window:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">rollback_config:</span></span><br><span class="line">      <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">      <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">    <span class="attr">update_config:</span></span><br><span class="line">      <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">failure_action:</span> <span class="string">pause</span></span><br><span class="line">      <span class="attr">monitor:</span> <span class="string">15s</span></span><br><span class="line">      <span class="attr">max_failure_ratio:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">order:</span> <span class="string">stop-first</span></span><br><span class="line">    <span class="attr">placement:</span></span><br><span class="line">      <span class="attr">constraints:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.labels.role==base</span></span><br></pre></td></tr></table></figure><p>多个依赖服务的情况下采用逗号分隔</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br></pre></td></tr></table></figure><p>docker-compose.yml容器编排工具对应的服务没有定义WAIT_HOSTS环境变量的情况下，Dockerfile添加docker-compsoe-wait支持不生效</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E4%B8%89)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Docker/blogs/Docker%E9%83%A8%E7%BD%B2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4(%E4%B8%89)/" class="post-title-link" itemprop="url">Docker部署微服务集群(三)</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-12-05 16:31:11" itemprop="dateCreated datePublished" datetime="2024-12-05T16:31:11+08:00">2024-12-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>11k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>10 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-bluedocker-compose%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B8%8Edocker-%E5%BC%95%E6%93%8E%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94span"><span id="inline-blue">docker-compose文件格式与docker 引擎版本对应</span></a></li><li><a href="#span-idinline-bluedocker-composeymlspan"><span id="inline-blue">docker-compose.yml</span></a><ul><li><a href="#span-idinline-bluedocker-compose-v3%E7%89%88%E6%9C%AC%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%AF%AD%E6%B3%95span"><span id="inline-blue">docker-compose V3版本配置项语法</span></a><ul><li><a href="#span-idinline-blueversionspan"><span id="inline-blue">version</span></a></li><li><a href="#span-idinline-bluebuildspan"><span id="inline-blue">build</span></a></li><li><a href="#span-idinline-bluecontextspan"><span id="inline-blue">context</span></a></li><li><a href="#span-idinline-bluedockerfilespan"><span id="inline-blue">dockerfile</span></a></li><li><a href="#span-idinline-blueargspan"><span id="inline-blue">ARG</span></a></li><li><a href="#span-idinline-bluecache_fromspan"><span id="inline-blue">cache_from</span></a></li><li><a href="#span-idinline-bluelabelspan"><span id="inline-blue">label</span></a></li><li><a href="#span-idinline-bluenetworkspan"><span id="inline-blue">network</span></a></li><li><a href="#span-idinline-blueshm_sizespan"><span id="inline-blue">shm_size</span></a></li><li><a href="#span-idinline-bluetargetspan"><span id="inline-blue">target</span></a></li><li><a href="#span-idinline-bluecap_add-cap_dropspan"><span id="inline-blue">cap_add、cap_drop</span></a></li><li><a href="#span-idinline-bluecgroup_parentspan"><span id="inline-blue">cgroup_parent</span></a></li><li><a href="#span-idinline-bluecommandspan"><span id="inline-blue">command</span></a></li><li><a href="#span-idinline-bluecontainer_namespan"><span id="inline-blue">container_name</span></a></li></ul></li></ul></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>Docker: 26.1.4<br>docker-compose: v2.25.0</p><h1><span id="背景"><span id="inline-blue">背景</span></span></h1><p>为了更好的管理docker镜像和容器服务，引入docker-compose容器编排工具，统一配置和集成微服务和基础服务</p><h1><span id="docker-compose文件格式与docker-引擎版本对应"><span id="inline-blue">docker-compose文件格式与docker 引擎版本对应</span></span></h1><p>docker-compose和docker engine版本说明：</p><table><thead><tr><th align="center">docker-compose文件格式</th><th align="center">Docker compose 版本</th><th align="center">Docker 引擎</th></tr></thead><tbody><tr><td align="center">3.8</td><td align="center">1.13.0+</td><td align="center">19.03.0+</td></tr><tr><td align="center">3.7</td><td align="center">1.13.0+</td><td align="center">18.06.0+</td></tr><tr><td align="center">3.6</td><td align="center">1.13.0+</td><td align="center">18.02.0+</td></tr><tr><td align="center">3.5</td><td align="center">1.13.0+</td><td align="center">17.12.0+</td></tr><tr><td align="center">3.4</td><td align="center">1.13.0+</td><td align="center">17.09.0+</td></tr><tr><td align="center">3.3</td><td align="center">1.13.0+</td><td align="center">17.06.0+</td></tr><tr><td align="center">3.2</td><td align="center">1.13.0+</td><td align="center">17.04.0+</td></tr><tr><td align="center">3.1</td><td align="center">1.13.1+</td><td align="center">1.13.1+</td></tr><tr><td align="center">3.0</td><td align="center">1.13.0+</td><td align="center">1.13.0+</td></tr><tr><td align="center">2.4</td><td align="center">1.21.0+</td><td align="center">17.12.0+</td></tr><tr><td align="center">2.3</td><td align="center">1.16.0+</td><td align="center">17.06.0+</td></tr><tr><td align="center">2.2</td><td align="center">1.13.0+</td><td align="center">1.13.0+</td></tr><tr><td align="center">2.1</td><td align="center">1.9.0+</td><td align="center">1.12.0+</td></tr><tr><td align="center">2.0</td><td align="center">1.6+</td><td align="center">1.10.0+</td></tr><tr><td align="center">1.0</td><td align="center">1.6</td><td align="center">1.10</td></tr></tbody></table><p>docker-compose文件格式一共有3个版本，V1,V2,V3<br>V1:<br>docker-compose-1.6之前版本配合Dokcer engine-1.10.0版本兼容V1文件格式<br>未声明版本的Compose 文件被视为”版本 1”。在这些文件中，所有服务都在文档的根目录下声明,目前已弃用。<br>V1文件无法声明命名volume、network、build参数。<br>示例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">  <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">&quot;8000:5000&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">.:/code</span></span><br><span class="line">  <span class="attr">links:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure><p>V2:<br>docker-compose-1.6至1.21.0版本配合Docker engine-1.10.0至1.13.0版本兼容V2文件格式<br>版本特性：<br>支持 depends_on 关键字定义服务之间的依赖关系。<br>支持 healthcheck 关键字定义健康检查。<br>支持 constraints 关键字定义服务部署约束。<br>支持 secrets 关键字定义加密数据。<br>支持 configs 关键字定义配置文件。<br>支持 scale 关键字定义服务副本数量。<br>支持 deploy 关键字定义服务的部署方式</p><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;2.4&quot;</span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    depends_on:</span><br><span class="line">      db:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      redis:</span><br><span class="line">        condition: service_started</span><br><span class="line">  redis:</span><br><span class="line">    image: redis</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line">    healthcheck:</span><br><span class="line">      test: &quot;exit 0&quot;</span><br></pre></td></tr></table></figure><p>V3:<br>docker-compose-1.13.0版本配合Docker engine-1.13.0至19.03.0版本兼容V3文件格式,主要是为了解决docker-compose支持集群swarm模式部署<br>版本特性：<br>支持新的服务控制指令，如 up, down, start, stop, restart, kill, ps, logs, pause, unpause, rm 等。<br>支持新的服务编排功能，如 profiles 和 stack。<br>支持新的网络和卷插件。<br>支持新的环境变量处理方式。<br>支持新的健康检查语法。<br>支持新的服务更新策略。<br>支持新的服务扩展策略。<br>支持新的服务监控和日志记录功能。<br>支持新的服务安全特性，如 secrets 和 configs。</p><h1><span id="docker-composeyml"><span id="inline-blue">docker-compose.yml</span></span></h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">photoframe-mysql:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/conf:/etc/mysql/conf.d</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/log:/var/mysql/log</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/data:/var/mysql/data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/db/init:/docker-entrypoint-initdb.d/:ro</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./mysql/db/sql:/opt/sql/:ro</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">coship</span></span><br><span class="line">  <span class="attr">photoframe-nacos:</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">photoframe-nacos</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">./nacos</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="attr">networks:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">        <span class="attr">environment:</span></span><br><span class="line">          <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">          <span class="attr">MODE:</span> <span class="string">standalone</span></span><br><span class="line">          <span class="attr">PREFER_HOST_MODE:</span> <span class="string">ip</span></span><br><span class="line">          <span class="attr">SPRING_DATASOURCE_PLATFORM:</span> <span class="string">mysql</span></span><br><span class="line">          <span class="attr">MYSQL_SERVICE_HOST:</span> <span class="string">photoframe-mysql</span></span><br><span class="line">          <span class="attr">MYSQL_SERVICE_PORT:</span> <span class="number">3306</span></span><br><span class="line">          <span class="attr">MYSQL_SERVICE_USER:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">MYSQL_SERVICE_PASSWORD:</span> <span class="string">coship</span></span><br><span class="line">          <span class="attr">MYSQL_SERVICE_DB_NAME:</span> <span class="string">nacos_config</span></span><br><span class="line">          <span class="attr">JVM_XMS:</span> <span class="string">1g</span></span><br><span class="line">          <span class="attr">JVM_XMX:</span> <span class="string">1g</span></span><br><span class="line">          <span class="attr">JVM_XMN:</span> <span class="string">128m</span></span><br><span class="line">          <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306</span></span><br><span class="line">          <span class="attr">WAIT_TIMEOUT:</span> <span class="number">120</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./nacos/logs/:/home/nacos/logs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">./nacos/conf/:/home/nacos/conf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;9848:9848&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;9849:9849&quot;</span></span><br><span class="line">        <span class="attr">depends_on:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">  <span class="attr">photoframe-elasticsearch:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-elasticsearch</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./elasticsearch</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">    <span class="comment"># 开启内存锁定</span></span><br><span class="line">      <span class="attr">bootstrap.memory_lock:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">ES_JAVA_OPTS:</span> <span class="string">&quot;-Xms4g -Xmx4g&quot;</span></span><br><span class="line">    <span class="comment"># 指定单节点启动</span></span><br><span class="line">      <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="comment"># 取消内存相关限制 用于开启内存锁定</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/data:/usr/local/elasticsearch-8.8.0/data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/logs:/usr/local/elasticsearch-8.8.0/logs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/config:/usr/local/elasticsearch-8.8.0/config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./elasticsearch/plugins:/usr/local/elasticsearch-8.8.0/plugins</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9300:9300&quot;</span></span><br><span class="line">  <span class="attr">photoframe-redis:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./redis/conf:/etc/redis/</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">  <span class="attr">photoframe-rabbitmq:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-rabbitmq</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;5672:5672&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;15672:15672&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/data:/var/lib/rabbitmq</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/log:/var/log/rabbitmq</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./rabbitmq/conf:/etc/rabbitmq</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">  <span class="attr">photoframe-admin-log:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-admin-log</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-admin-log</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9021:9021&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-admin-biz:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-admin-biz</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-admin-biz</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9020:9020&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-api-app:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-api-app</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-api-app</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9006:9006&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-api-pad:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-api-pad</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-api-pad</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9007:9007&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./photoframe/uploadPath:/home/photoframe/uploadPath</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-auth:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-auth</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-auth</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9003:9003&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-quartz:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-quartz</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-quartz</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9060:9060&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-mysql:3306,photoframe-nacos:8848,photoframe-redis:6379</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-gateway:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-gateway</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./photoframe/photoframe-gateway</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-redis</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-nacos:8848,photoframe-redis:6379,photoframe-admin-biz:9020,photoframe-admin-log:9021,photoframe-api-app:9006,photoframe-api-pad:9007,photoframe-auth:9003,photoframe-quartz:9060</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-nginx:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-nginx</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./nginx</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nginx/conf:/etc/nginx/conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./nginx/logs:/var/log/nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-gateway</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-gateway:9001</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">photoframe-sentinel:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-sentinel</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./sentinel</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;8180:8180&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./sentinel/logs:/root/logs</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-nacos:8848</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-zipkin:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-zipkin</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./zipkin</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9411:9411&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-elasticsearch:9200</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line">  <span class="attr">photoframe-zipkin-dependencies:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">photoframe-zipkin-dependencies</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./zipkin-dependencies</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">photoframe-elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">WAIT_HOSTS:</span> <span class="string">photoframe-elasticsearch:9200</span></span><br><span class="line">      <span class="attr">WAIT_TIMEOUT:</span> <span class="number">180</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">photoframe-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><h2><span id="docker-compose-v3版本配置项语法"><span id="inline-blue">docker-compose V3版本配置项语法</span></span></h2><h3><span id="version"><span id="inline-blue">version</span></span></h3><p>顶级version属性由Compose规范定义以实现向后兼容性它仅提供信息，如果使用版本规范不支持的属性，将收到一条警告消息，表明它已过时。<br>version属性包含主要版本和次要版本，如果在V2版本规范下定义如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br></pre></td></tr></table></figure><p>等同于：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.0&#x27;</span></span><br></pre></td></tr></table></figure><p>V2版本在不明确指定次要版本的情况下，默认匹配最早的次要版本。</p><p>V3版本规范下定义如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br></pre></td></tr></table></figure><p>等同于：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.0&#x27;</span></span><br></pre></td></tr></table></figure><p>V3版本在不明确指定次要版本的情况下，默认匹配最早的次要版本。</p><h3><span id="build"><span id="inline-blue">build</span></span></h3><p>在构建时应用的配置选项。<br>build可以指定为包含构建上下文路径的字符串：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./dir</span></span><br></pre></td></tr></table></figure><p>或者，作为一个对象，其路径在 context下指定，并且可选 Dockerfile和 args：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./dir</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">buildno:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>如果指定image以及tag，则Compose会使用指定的image和选项build来命名构建的映像：webapp:tag</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span> <span class="string">./dir</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">webapp:tag</span></span><br></pre></td></tr></table></figure><h3><span id="context"><span id="inline-blue">context</span></span></h3><p>包含 Dockerfile 的目录的路径，或 git 存储库的 url。<br>当提供的值是相对路径时，它将被解释为相对于Compose文件的位置。该目录也是发送到Docker守护进程的构建上下文。<br>Compose构建并使用生成的名称对其进行标记，然后使用该图像。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">./dir</span></span><br></pre></td></tr></table></figure><h3><span id="dockerfile"><span id="inline-blue">dockerfile</span></span></h3><p>备用 Dockerfile。<br>Compose使用备用文件进行构建。还必须指定构建路径。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br></pre></td></tr></table></figure><h3><span id="arg"><span id="inline-blue">ARG</span></span></h3><p>添加构建参数，这些参数是仅在构建过程中可访问的环境变量。<br>首先，在 Dockerfile 中指定参数：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># syntax=docker/dockerfile:1</span></span><br><span class="line"></span><br><span class="line"><span class="string">ARG</span> <span class="string">buildno</span></span><br><span class="line"><span class="string">ARG</span> <span class="string">gitcommithash</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">&quot;Build number: $buildno&quot;</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">&quot;Based on commit: $gitcommithash&quot;</span></span><br></pre></td></tr></table></figure><p>然后指定该键下的参数build。您可以传递映射或列表：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">args:</span></span><br><span class="line">    <span class="attr">buildno:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">gitcommithash:</span> <span class="string">cdc3b19</span></span><br></pre></td></tr></table></figure><p>列表形式</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">buildno=1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">gitcommithash=cdc3b19</span></span><br></pre></td></tr></table></figure><p>在您的 Dockerfile 中，如果您在指令ARG之前指定FROM， ARG则在下一个FROM的构建指令中不可用。如果您需要在两个地方都提供一个参数，也请在FROM指令下指定它<br>您可以在指定构建参数时省略该值，在这种情况下，其在构建时的值是 Compose 运行环境中的值。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">args:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">buildno</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gitcommithash</span></span><br></pre></td></tr></table></figure><p>YAML布尔值( “true”, “false”, “yes”, “no”, “on”, “off”) 必须用引号引起来，以便解析器将它们解释为字符串。</p><h3><span id="cache_from"><span id="inline-blue">cache_from</span></span></h3><p>引擎用于缓存解析的图像列表。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">cache_from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">alpine:latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">corp/web_app:3.14</span></span><br></pre></td></tr></table></figure><p>3.3版本docker compose文件格式添加</p><h3><span id="label"><span id="inline-blue">label</span></span></h3><p>使用Docker 标签将元数据添加到生成的图像中 。您可以使用数组或字典。<br>建议使用反向DNS表示法，以防止您的标签与其他软件使用的标签发生冲突。</p><p>单值映射：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">com.example.description:</span> <span class="string">&quot;Accounting webapp&quot;</span></span><br><span class="line">    <span class="attr">com.example.department:</span> <span class="string">&quot;Finance&quot;</span></span><br><span class="line">    <span class="attr">com.example.label-with-empty-value:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>列表形式：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;com.example.description=Accounting webapp&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;com.example.department=Finance&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;com.example.label-with-empty-value&quot;</span></span><br></pre></td></tr></table></figure><p>3.3版本docker compose文件格式添加</p><h3><span id="network"><span id="inline-blue">network</span></span></h3><p>设置网络容器连接以获取RUN构建期间的说明。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">host</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">custom_network_1</span></span><br></pre></td></tr></table></figure><p>用于none在构建期间禁用网络：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">network:</span> <span class="string">none</span></span><br></pre></td></tr></table></figure><p>3.4版本docker compose文件格式添加</p><h3><span id="shm_size"><span id="inline-blue">shm_size</span></span></h3><p>/dev/shm设置此构建容器的分区大小。指定为表示字节数的整数值或表示 字节值的字符串。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">shm_size:</span> <span class="string">&#x27;2gb&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">shm_size:</span> <span class="number">10000000</span></span><br></pre></td></tr></table></figure><p>3.5版本docker compose文件格式添加</p><h3><span id="target"><span id="inline-blue">target</span></span></h3><p>构建指定阶段，如Dockerfile</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">target:</span> <span class="string">prod</span></span><br></pre></td></tr></table></figure><p>3.4版本docker compose文件格式添加</p><h3><span id="cap_add-cap_drop"><span id="inline-blue">cap_add、cap_drop</span></span></h3><p>添加或删除容器功能</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cap_add:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cap_drop:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SYS_ADMIN</span></span><br></pre></td></tr></table></figure><h3><span id="cgroup_parent"><span id="inline-blue">cgroup_parent</span></span></h3><p>为容器指定一个可选的父 cgroup。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cgroup_parent:</span> <span class="string">m-executor-abcd</span></span><br></pre></td></tr></table></figure><p>在 Swarm 模式下部署堆栈时，该cgroup_parent选项将被忽略</p><h3><span id="command"><span id="inline-blue">command</span></span></h3><p>覆盖默认命令。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">thin</span> <span class="string">-p</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><p>该命令也可以是一个列表，其方式类似于 dockerfile：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">command:</span> [<span class="string">&quot;bundle&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;thin&quot;</span>, <span class="string">&quot;-p&quot;</span>, <span class="string">&quot;3000&quot;</span>]</span><br></pre></td></tr></table></figure><h3><span id="container_name"><span id="inline-blue">container_name</span></span></h3><p>指定自定义容器名称，而不是生成的默认名称。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">container_name:</span> <span class="string">my-web-container</span></span><br></pre></td></tr></table></figure><p>由于 Docker 容器名称必须是唯一的，因此如果指定了自定义名称，则无法将服务扩展至超过 1 个容器。尝试这样做会导致错误。<br>在 Swarm 模式下部署堆栈时，该container_name选项将被忽略。</p><p>参考：<a href="https://docker.github.net.cn/compose/compose-file/compose-file-v3/">https://docker.github.net.cn/compose/compose-file/compose-file-v3/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">vanishke</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.1m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">16:10</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/bookmark.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/search/local-search.min.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/tags/pdf.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/pace.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.2.0/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://github.com/vanishke/hexo/page/2/"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/quicklink.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous"><script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"vanishke","repo":"blog-comments","client_id":"95db1f51f05191be80c5","client_secret":"eccc0bbe52b90a08e97140cece84ee32577172b2","admin_user":"['vanishke']","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"c853ec00cc9d13bc22336b7d45d1416e"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/comments/gitalk.min.js"></script></body></html>