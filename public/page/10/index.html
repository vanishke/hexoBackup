<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"github.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":200,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/config.min.js"></script><meta property="og:type" content="website"><meta property="og:title" content="vanishke随笔"><meta property="og:url" content="https://github.com/vanishke/hexo/page/10/index.html"><meta property="og:site_name" content="vanishke随笔"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="vanishke"><meta property="article:tag" content="Java,Elasticsearch,MySQL,Linux"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://github.com/vanishke/hexo/page/10/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/10/index.html","title":""}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>vanishke随笔</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">vanishke随笔</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">善始者实繁，克终者盖寡</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">108</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">59</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">241</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="vanishke" src="/images/avatar.png"><p class="site-author-name" itemprop="name">vanishke</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">241</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">108</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/vanishke" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;vanishke"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:18685129726@163.com" title="E-Mail → mailto:18685129726@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-recent-posts motion-element"><div class="links-of-recent-posts-title"><i class="fa fa-history fa-fw"></i> 最近文章</div><ul class="links-of-recent-posts-list"><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Docker%E9%83%A8%E7%BD%B2Redis%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="Docker&#x2F;blogs&#x2F;Docker部署Redis超时问题排查与解决方案&#x2F;">Docker部署Redis超时问题排查与解决方案</a></li><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Docker%E5%AE%B9%E5%99%A8%E4%B8%AD%20Java%20%E9%AA%8C%E8%AF%81%E7%A0%81%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3/" title="Docker&#x2F;blogs&#x2F;Docker容器中 Java 验证码服务部署问题排查与解决&#x2F;">Docker容器中 Java 验证码服务部署问题排查与解决</a></li><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Docker-Swarm%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%AE%9E%E7%8E%B0MySQL%E5%A4%87%E4%BB%BD/" title="Docker&#x2F;blogs&#x2F;Docker-Swarm模式下实现MySQL备份&#x2F;">Docker-Swarm模式下实现MySQL备份</a></li><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Portainer%20CE%E5%8F%AF%E8%A7%86%E5%8C%96Docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" title="Docker&#x2F;blogs&#x2F;Portainer CE可视化Docker容器管理使用指南&#x2F;">Portainer CE可视化Docker容器管理使用指南</a></li><li class="links-of-recent-posts-item"><a href="/Docker/blogs/Docker%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2MySQL%E3%80%81Redis%E3%80%81Nginx%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/" title="Docker&#x2F;blogs&#x2F;Docker本地部署MySQL、Redis、Nginx基础服务&#x2F;">Docker本地部署MySQL、Redis、Nginx基础服务</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/vanishke" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/SpringCloud/blogs/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E5%BC%95%E5%85%A5redisson%E5%AF%BC%E8%87%B4@cacheable%E5%A4%B1%E6%95%88%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/SpringCloud/blogs/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97%E5%BC%95%E5%85%A5redisson%E5%AF%BC%E8%87%B4@cacheable%E5%A4%B1%E6%95%88%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/" class="post-title-link" itemprop="url">微服务模块引入Redisson导致@cacheable失效解决办法</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-03-06 17:47:20" itemprop="dateCreated datePublished" datetime="2024-03-06T17:47:20+08:00">2024-03-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SpringCloud/" itemprop="url" rel="index"><span itemprop="name">SpringCloud</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>816</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%8E%B0%E8%B1%A1span"><span id="inline-blue">现象</span></a></li><li><a href="#span-idinline-blue%E5%8E%9F%E5%9B%A0span"><span id="inline-blue">原因</span></a></li><li><a href="#span-idinline-blue%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95span"><span id="inline-blue">解决办法</span></a></li></ul><h2><span id="环境"><span id="inline-blue">环境</span></span></h2><p>SpringCloud : 2021.0.5<br>SpringBoot : 2.2.6.RELEASE<br>Spring : 5.2.5.RELEASE<br>redisson : 3.12.5<br>Java : 1.8<br>MySQL : 5.7</p><h2><span id="现象"><span id="inline-blue">现象</span></span></h2><p>微服务引入redisson模块依赖之后发现启动出现Cannot find cache named RedisClientCache</p><h2><span id="原因"><span id="inline-blue">原因</span></span></h2><p>报错部分代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable(value = &#123; &quot;RedisClientCache&quot; &#125;, unless = &quot;#result == null&quot;, key = &quot;T(com.ffcs.platform.common.base.constants.GlobalsConstants).CLIENT_DETAILS_KEY.concat(T(String).valueOf(#clientId))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OauthClientDetails <span class="title">findOauthClientDetailsByClientId</span><span class="params">(String clientId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> oauthClientDetailsDao.getOauthClientDetailsByClientId(clientId);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在未添加redisson之前，启动没有问题，怀疑是因为redisson和@Cacheable冲突导致缓存对象RedisClientCache未创建，查询了之后发现确实是因为redisson的影响导致，参考如下<br><a href="https://dandelioncloud.cn/article/details/1517352520602173442">https://dandelioncloud.cn/article/details/1517352520602173442</a></p><h2><span id="解决办法"><span id="inline-blue">解决办法</span></span></h2><p>模块对应启动配置文件增加配置项如下:</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.cache.type</span>=<span class="string">redis   </span></span><br><span class="line"><span class="meta">spring.cache.cache-names</span>=<span class="string">RedisClientCache</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Linux/blogs/MySQL%E5%9C%A8%E7%BA%BF%E6%B8%85%E7%90%86%E5%A4%A7%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Linux/blogs/MySQL%E5%9C%A8%E7%BA%BF%E6%B8%85%E7%90%86%E5%A4%A7%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">MySQL在线清理大表数据方法</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-03-01 17:11:20" itemprop="dateCreated datePublished" datetime="2024-03-01T17:11:20+08:00">2024-03-01</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.5k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a></li></ul><h2><span id="环境"><span id="inline-blue">环境</span></span></h2><p>Linux : CentOS Linux release 7.6.1810 (Core)<br>MySQL : 5.7</p><h2><span id="背景"><span id="inline-blue">背景</span></span></h2><p>现网模块在运行一段时间之后发现产生大量业务日志，占用系统硬盘空间，需要在线将历史数据清除，只保留1年的记录</p><h2><span id="实现"><span id="inline-blue">实现</span></span></h2><p>按日期统计查询t_sys_log表数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> DATE_FORMAT(t.createTime,&quot;%Y-%m-%d&quot;) <span class="type">date</span>,<span class="built_in">count</span>(<span class="operator">*</span>) num <span class="keyword">from</span> t_sys_log t</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> DATE_FORMAT(t.createTime,&quot;%Y-%m-%d&quot;)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num</span><br><span class="line"><span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><p>创建一张和原始表一样结构的新表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `t_sys_log_new` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;编号&#x27;</span>,</span><br><span class="line">  `moduleName` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;模块名称&#x27;</span>,</span><br><span class="line">  `moduleType` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;模块类型&#x27;</span>,</span><br><span class="line">  `action` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作类型&#x27;</span>,</span><br><span class="line">  `operatorType` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作员类型&#x27;</span>,</span><br><span class="line">  `operatorName` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作员名称&#x27;</span>,</span><br><span class="line">  `operatorId` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作员ID&#x27;</span>,</span><br><span class="line">  `operatorIp` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;操作员IP&#x27;</span>,</span><br><span class="line">  `logText` longtext COMMENT <span class="string">&#x27;日志信息&#x27;</span>,</span><br><span class="line">  `createTime` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> UPDATE <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `index_sys_log_moduleType` (`moduleType`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `index_sys_log_action` (`action`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `index_sys_log_operatorName` (`operatorName`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  KEY `index_sys_log_createTime` (`createTime`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;日志信息表&#x27;</span>;</span><br></pre></td></tr></table></figure><p>将2023年的业务日志记录暂存到t_sys_log_new</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replace <span class="keyword">into</span> t_sys_log_new</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t_sys_log t</span><br><span class="line"><span class="keyword">where</span> t.createTime <span class="operator">&gt;=</span>&quot;2023-01-01 00:00:00&quot;;</span><br></pre></td></tr></table></figure><p>清空原始表<br>删除原始表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> t_sys_log;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> t_sys_log;</span><br></pre></td></tr></table></figure><p>将新表重命名为原始表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">table</span> t_sys_log_new <span class="keyword">to</span> t_sys_log;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Linux/blogs/%E5%88%86%E6%9E%90curl%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E8%80%97%E6%97%B6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Linux/blogs/%E5%88%86%E6%9E%90curl%E5%91%BD%E4%BB%A4%E8%AF%B7%E6%B1%82%E8%80%97%E6%97%B6/" class="post-title-link" itemprop="url">分析curl命令请求耗时</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-02-26 15:11:20" itemprop="dateCreated datePublished" datetime="2024-02-26T15:11:20+08:00">2024-02-26</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a></li></ul><h2><span id="环境"><span id="inline-blue">环境</span></span></h2><p>Linux : CentOS Linux release 7.6.1810 (Core)</p><h2><span id="背景"><span id="inline-blue">背景</span></span></h2><p>项目部署Linux服务器之后，接口涉及第三方请求耗时达到3秒左右，需要进一步分析耗时发生在那个阶段</p><h2><span id="实现"><span id="inline-blue">实现</span></span></h2><p>curl命令统计各阶段耗时<br>在当前调用curl命令路径下新建一个文件curl-format.txt，文件内部添加以下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">time_namelookup:  %&#123;time_namelookup&#125;s\n</span><br><span class="line">        time_connect:  %&#123;time_connect&#125;s\n</span><br><span class="line">     time_appconnect:  %&#123;time_appconnect&#125;s\n</span><br><span class="line">    time_pretransfer:  %&#123;time_pretransfer&#125;s\n</span><br><span class="line">       time_redirect:  %&#123;time_redirect&#125;s\n</span><br><span class="line">  time_starttransfer:  %&#123;time_starttransfer&#125;s\n</span><br><span class="line">                     ----------\n</span><br><span class="line">          time_total:  %&#123;time_total&#125;s\n</span><br></pre></td></tr></table></figure><p>执行curl命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -w &quot;@curl-format.txt&quot; -o NUL -s &quot;http://10.9.216.12:9001/dev/appapi/tvBox/api/queryBindUsers&quot;</span><br></pre></td></tr></table></figure><p>参数说明：<br>-w “@curl-format.txt” 通知cURL使用格式化的输出文件<br>-o /dev/null 将请求的输出重定向到/dev/null<br>-s 通知cURL不显示进度条<br>“<a href="http://10.9.216.12:9001/dev/appapi/tvBox/api/queryBindUsers&quot;">http://10.9.216.12:9001/dev/appapi/tvBox/api/queryBindUsers&quot;</a> 是我们请求的URL，请使用引号包围（尤其当你的URL包含&amp;查询字符串）</p><p>调用结果分析输出</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> time_namelookup: 0.000</span><br><span class="line">      time_connect: 0.000</span><br><span class="line">   time_appconnect: 0.000</span><br><span class="line">     time_redirect: 0.000</span><br><span class="line">  time_pretransfer: 0.001</span><br><span class="line">time_starttransfer: 0.049</span><br><span class="line">                    ----------</span><br><span class="line">time_total: 0.049</span><br></pre></td></tr></table></figure><p>输出内容各项释义</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">time_namelookup：DNS 域名解析需要的时间</span><br><span class="line">time_connect：TCP 连接建立的时间，就是三次握手的时间</span><br><span class="line">time_appconnect：SSL/SSH等上层协议建立连接的时间，比如 connect/handshake 的时间</span><br><span class="line">time_pretransfer：从请求开始到响应开始传输的时间</span><br><span class="line">time_starttransfer：从请求开始到第一个字节将要传输的时间</span><br><span class="line">time_total：这次请求花费的全部时间</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Nginx/blogs/Nginx%E5%9F%BA%E4%BA%8E%E7%89%B9%E5%AE%9A%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E7%9A%84location%E5%8C%B9%E9%85%8D/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Nginx/blogs/Nginx%E5%9F%BA%E4%BA%8E%E7%89%B9%E5%AE%9A%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E7%9A%84location%E5%8C%B9%E9%85%8D/" class="post-title-link" itemprop="url">Nginx基于特定访问路径的location匹配</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-25 17:11:20" itemprop="dateCreated datePublished" datetime="2024-01-25T17:11:20+08:00">2024-01-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E8%83%8C%E6%99%AFspan"><span id="inline-blue">背景</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a></li><li><a href="#span-idinline-blue%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%E6%8C%87%E4%BB%A4root%E5%92%8Calias%E7%9A%84%E5%B7%AE%E5%BC%82span"><span id="inline-blue">文件访问指令root和alias的差异</span></a></li></ul><h2><span id="环境"><span id="inline-blue">环境</span></span></h2><p>Linux : CentOS Linux release 7.6.1810 (Core)<br>Nginx : nginx/1.18.0</p><h2><span id="背景"><span id="inline-blue">背景</span></span></h2><p>项目最近实现了”一键置灰”功能，通过在原始接口下发的图片访问路径增加一层路径实现切换到自定义图片访问地址。</p><p>接口下发图片地址：<br>图片灰色地址：<a href="http://10.9.216.103:8098/grey/oms-pic/special/common/048/10033.png">http://10.9.216.103:8098/grey/oms-pic/special/common/048/10033.png</a><br>图片彩色地址：<a href="http://10.9.216.103:8098/oms-pic/special/common/048/10033.png">http://10.9.216.103:8098/oms-pic/special/common/048/10033.png</a></p><p>灰色主题下本地图片访问路径：/home/nanjing_oms/grey/oms-pic/special/common/048/10033.png<br>彩色主题下本地图片访问路径：/home/nanjing_oms/oms-pic/special/common/048/10033.png</p><p>灰色主题下访问路径在oms-pic前面多了/grey/路径。</p><h2><span id="实现"><span id="inline-blue">实现</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       8098;</span><br><span class="line">        server_name  10.9.216.104;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line">        # access_log off;</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 访问根路径匹配/grey的情况下访问/home/nanjing_oms/grey/oms-pic</span></span><br><span class="line">        location ^~ /grey &#123;</span><br><span class="line">            #expires 3d;</span><br><span class="line">			autoindex on;</span><br><span class="line">            root /home/nanjing_oms/;</span><br><span class="line">            #proxy_store on;</span><br><span class="line">            #proxy_store_access user:rw group:rw all:rw;</span><br><span class="line">            #proxy_temp_path ./proxy_temp;</span><br><span class="line">            if ( !-e $request_filename)  &#123;</span><br><span class="line">                 #proxy_pass http://10.9.216.103:8060$uri;</span><br><span class="line">            &#125;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 访问根路径匹配/oms-pic的情况下访问/home/nanjing_oms/oms-pic</span></span><br><span class="line">		location ^~ /oms-pic &#123;</span><br><span class="line">            #expires 3d;</span><br><span class="line">			autoindex on;</span><br><span class="line">            root /home/nanjing_oms/;</span><br><span class="line">            #proxy_store on;</span><br><span class="line">            #proxy_store_access user:rw group:rw all:rw;</span><br><span class="line">            #proxy_temp_path ./proxy_temp;</span><br><span class="line">            if ( !-e $request_filename)  &#123;</span><br><span class="line">                 #proxy_pass http://10.9.216.103:8060$uri;</span><br><span class="line">            &#125;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;   </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2><span id="文件访问指令root和alias的差异"><span id="inline-blue">文件访问指令root和alias的差异</span></span></h2><p>root: 服务器实际访问路径为 root路径 ＋ location路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location /html &#123;</span><br><span class="line">	root /usr/local/nginx/;</span><br><span class="line">&#125;</span><br><span class="line">请求:  http://10.9.212.55:8080/html/a.html =&gt; 匹配服务器文件: /usr/local/nginx/html/a.html</span><br><span class="line">请求:  http:/10.9.212.55:8080/html/www/a.html =&gt; 匹配服务器文件: /usr/local/nginx/html/www/a.html</span><br></pre></td></tr></table></figure><p>alias: 服务器实际访问路径为 alias路径 ＋ 去掉location路径后的请求路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location /html &#123;</span><br><span class="line">	alias /usr/local/nginx/;</span><br><span class="line">&#125;</span><br><span class="line">请求:  http://10.9.212.55:8080/html/a.html =&gt; 匹配服务器文件: /usr/local/nginx/a.html</span><br><span class="line">请求:  http://10.9.212.55:8080/html/www/a.html =&gt; 匹配服务器文件: /usr/local/nginx/www/a.html</span><br><span class="line"></span><br><span class="line">location /html/www &#123;</span><br><span class="line">	alias /usr/local/nginx;</span><br><span class="line">&#125;</span><br><span class="line">请求:  http://10.9.212.55:8080/html/www/a.html =&gt; 匹配服务器文件: /usr/local/nginx/a.html</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Elasticsearch/blogs/Elasticsearch%E7%B4%A2%E5%BC%95%E5%87%BA%E7%8E%B0docs.deleted%E6%9A%B4%E5%A2%9E%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Elasticsearch/blogs/Elasticsearch%E7%B4%A2%E5%BC%95%E5%87%BA%E7%8E%B0docs.deleted%E6%9A%B4%E5%A2%9E%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/" class="post-title-link" itemprop="url">Elasticsearch索引出现docs.deleted暴增的解决办法</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-25 15:26:20" itemprop="dateCreated datePublished" datetime="2024-01-25T15:26:20+08:00">2024-01-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>371</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%8E%B0%E8%B1%A1span"><span id="inline-blue">现象</span></a></li><li><a href="#span-idinline-blue%E5%8E%9F%E5%9B%A0span"><span id="inline-blue">原因</span></a><ul><li><a href="#span-idinline-blue%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95span"><span id="inline-blue">解决办法</span></a></li></ul></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>linux : CentOS Linux release 7.7.1908 (Core)<br>Elasticsearch : 6.8.4</p><h1><span id="现象"><span id="inline-blue">现象</span></span></h1><p>通过_update_by_query接口变更索引的属性映射，操作完成后索引新增属性成功了，但是索引对应的docs.deleted记录暴增，占用10多个G。</p><h1><span id="原因"><span id="inline-blue">原因</span></span></h1><p>由于Lucene索引中段的不可变性，删除操作并不容易。对于对原始文档的任何更改操作，例如重新索引或更新，都需要删除文档，将其标记为已删除，并在后台创建包含更改的新文档。</p><h2><span id="解决办法"><span id="inline-blue">解决办法</span></span></h2><p>通过Elasticsearch的接口调用强制执行分段合并。<br>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST &quot;http://10.9.216.12:9200/user_action_moui_202312/_forcemerge?max_num_segments=1&quot;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Elasticsearch/blogs/Elasticsearch%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF%E5%B9%B6%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%86%E5%8F%B2%E7%B4%A2%E5%BC%95/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Elasticsearch/blogs/Elasticsearch%E4%BF%AE%E6%94%B9%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF%E5%B9%B6%E5%BA%94%E7%94%A8%E5%88%B0%E5%8E%86%E5%8F%B2%E7%B4%A2%E5%BC%95/" class="post-title-link" itemprop="url">Elasticsearch修改索引模板并应用到历史索引</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-24 11:26:20" itemprop="dateCreated datePublished" datetime="2024-01-24T11:26:20+08:00">2024-01-24</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>14k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>13 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%9B%AE%E7%9A%84span"><span id="inline-blue">目的</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a><ul><li><a href="#span-idinline-blue%E6%9B%B4%E6%94%B9%E5%8E%86%E5%8F%B2%E7%B4%A2%E5%BC%95mapping%E6%98%A0%E5%B0%84span"><span id="inline-blue">更改历史索引mapping映射</span></a></li><li><a href="#span-idinline-blue%E9%AA%8C%E8%AF%81span"><span id="inline-blue">验证</span></a></li></ul></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>linux : CentOS Linux release 7.7.1908 (Core)<br>Elasticsearch : 6.8.4</p><h1><span id="目的"><span id="inline-blue">目的</span></span></h1><p>Elasticsearch统计用户的访问记录，需要在已有模板的基础上增加几个上报属性，通过head和SQL插件能够查询到新增的属性，并将新增的属性应用到已存在的历史索引<br>新增属性：<br>softwareVersion(String) : 软件版本<br>hdVersion(String): 硬件版本<br>model(String): 硬件型号<br>socmodel(String): 芯片型号<br>districtCodeName(String): 区域名称<br>mac(String): MAC地址</p><h1><span id="实现"><span id="inline-blue">实现</span></span></h1><p>原始模板：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  <span class="attr">&quot;order&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span> : <span class="string">&quot;user_action_*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span> : <span class="string">&quot;6&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;refresh_interval&quot;</span> : <span class="string">&quot;30s&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;translog.flush_threshold_size&quot;</span> : <span class="string">&quot;1024mb&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;action&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;_all&quot;</span>: &#123; <span class="attr">&quot;enabled&quot;</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;eTime&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;time&quot;</span> :       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>&#125;,</span><br><span class="line">          <span class="attr">&quot;clientIp&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;ip&quot;</span>&#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;eType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;eId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tProtocol&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;login&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;uc&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;areaCode&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tModel&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;sceneId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;videoId&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pVideoId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;videoIndex&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;videoDuration&quot;</span>:&#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tsId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;serId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;netId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;chName&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;progName&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;aId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rName&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rFlag&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;paId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;ppId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pkgFlag&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;eStatus&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;uuid&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;lat&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;lng&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;netType&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;sn&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tOS&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;way&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;epbt&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;epet&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,         </span><br><span class="line">          <span class="attr">&quot;productCode&quot;</span>: &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;kw&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;recomId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coName&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coType&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;actionType&quot;</span>:  &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;orderType&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;logicNumber&quot;</span>: &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;chargeNum&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;viewType&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;viewPath&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;appId&quot;</span> :      &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appName&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appType&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appVersion&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">                          </span><br><span class="line">          <span class="attr">&quot;startTime&quot;</span> :  &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,   </span><br><span class="line">          <span class="attr">&quot;endTime&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;duration&quot;</span> :   &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>变更后模板:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;order&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span> : <span class="string">&quot;user_action_*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span> : <span class="string">&quot;6&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;refresh_interval&quot;</span> : <span class="string">&quot;30s&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;translog.flush_threshold_size&quot;</span> : <span class="string">&quot;1024mb&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;action&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;_all&quot;</span>: &#123; <span class="attr">&quot;enabled&quot;</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;eTime&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span>: <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;time&quot;</span> :       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>&#125;,</span><br><span class="line">          <span class="attr">&quot;clientIp&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;ip&quot;</span>&#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;eType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;eId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tProtocol&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;login&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;uc&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;areaCode&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tModel&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;sceneId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;videoId&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pVideoId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;videoIndex&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;videoDuration&quot;</span>:&#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tsId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;serId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;netId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;chName&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;progName&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;aId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pId&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rName&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rFlag&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;paId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;ppId&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;pkgFlag&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;eStatus&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;uuid&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;lat&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;lng&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;netType&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;sn&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;tOS&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;way&quot;</span>:         &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;epbt&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;epet&quot;</span>:        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,         </span><br><span class="line">          <span class="attr">&quot;productCode&quot;</span>: &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>:<span class="literal">true</span> &#125;,</span><br><span class="line">          </span><br><span class="line">          <span class="attr">&quot;kw&quot;</span>:          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;rType&quot;</span>:       &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;recomId&quot;</span>:     &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coName&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;coType&quot;</span>:      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;actionType&quot;</span>:  &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;orderType&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;logicNumber&quot;</span>: &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;chargeNum&quot;</span>:   &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;viewType&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;viewPath&quot;</span>:    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span> &#125;,</span><br><span class="line"></span><br><span class="line">          <span class="attr">&quot;appId&quot;</span> :      &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appName&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appType&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;appVersion&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">                          </span><br><span class="line">          <span class="attr">&quot;startTime&quot;</span> :  &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,   </span><br><span class="line">          <span class="attr">&quot;endTime&quot;</span> :    &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>, <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;duration&quot;</span> :   &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span> &#125;,</span><br><span class="line">		  </span><br><span class="line">	      <span class="attr">&quot;softwareVersion&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">	      <span class="attr">&quot;hdVersion&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;model&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;socmodel&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">          <span class="attr">&quot;districtCodeName&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;,</span><br><span class="line">	      <span class="attr">&quot;mac&quot;</span> : &#123; <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>, <span class="attr">&quot;index&quot;</span> : <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>删除原始模板，创新新的索引模板，模板变更之后只对新增的索引有效，历史索引依然保持之前的mapping映射。</p><h2><span id="更改历史索引mapping映射"><span id="inline-blue">更改历史索引mapping映射</span></span></h2><p>索引: user_action_moui_202312</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST &quot;http://10.9.216.12:9200/user_action_moui_202312/_update_by_query?conflicts=proceed&amp;wait_for_completion=false&amp;&amp;slices=auto&amp;scroll_size=10000&quot; -d</span><br><span class="line">&#x27;&#123;</span><br><span class="line">    &quot;script&quot;: </span><br><span class="line">	&#123;</span><br><span class="line">        &quot;lang&quot;: &quot;painless&quot;,</span><br><span class="line">				&quot;source&quot;: &quot; if (ctx._source.softwareVersion == null) &#123;ctx._source.softwareVersion = &#x27;NULL&#x27;&#125; if (ctx._source.hdVersion == null) &#123;ctx._source.hdVersion = &#x27;NULL&#x27;&#125; if (ctx._source.model == null) &#123;ctx._source.model = &#x27;NULL&#x27;&#125; if (ctx._source.socmodel == null) &#123;ctx._source.socmodel = &#x27;NULL&#x27;&#125; if (ctx._source.districtCodeName == null)&#123;ctx._source.districtCodeName = &#x27;NULL&#x27;&#125; if (ctx._source.mac == null) &#123;ctx._source.mac = &#x27;NULL&#x27;&#125; &quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27;</span><br><span class="line"></span><br><span class="line">返回示例：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;task&quot;: &quot;z4Wm_2UETI2ni9yFXxjcew:974983&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_update_by_query接口的作用：<br>更新user_action_moui_202312历史索引新增属性softwareVersion、hdVersion、model、socmodel、districtCodeName、mac<br>如果索引记录中不存在对应的记录，设置默认值’NULL’<br>URL携带参数释义：</p><p>conflicts=proceed : 执行过程中出现冲突不停止,继续执行<br>wait_for_completion=false : 后台执行，避免执行超时<br>slices=auto : 分片执行<br>scroll_size=10000 ：采用Scroll方式翻页的大小，默认为1000</p><p>接口调用之后返回对应执行任务的taskId(),可以通过_tasks接口查询对应任务的执行进度，调用方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://10.9.216.12:9200/_tasks/z4Wm_2UETI2ni9yFXxjcew:974983 </span><br></pre></td></tr></table></figure><h2><span id="验证"><span id="inline-blue">验证</span></span></h2><p>通过SQL插件查询user_action_moui_*索引，验证新增字段属性是否生效<br><img src="/images/elasticsearch/es_20240116_001.png" alt="Elasticsearch索引变更"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Elasticsearch/blogs/Elasticsearch%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Elasticsearch/blogs/Elasticsearch%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/" class="post-title-link" itemprop="url">ElasticSearch开机自启动</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-17 16:11:35" itemprop="dateCreated datePublished" datetime="2024-01-17T16:11:35+08:00">2024-01-17</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.1k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E5%88%9B%E5%BB%BAelasticsearch%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6span"><span id="inline-blue">创建elasticsearch启动配置文件</span></a></li><li><a href="#span-idinline-blue%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90span"><span id="inline-blue">修改文件权限</span></a></li><li><a href="#span-idinline-blue%E6%B7%BB%E5%8A%A0%E5%92%8C%E5%88%A0%E9%99%A4%E8%87%AA%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1span"><span id="inline-blue">添加和删除自启动服务</span></a></li><li><a href="#span-idinline-blue%E5%BC%80%E5%90%AF%E5%92%8C%E5%85%B3%E9%97%AD%E6%9C%8D%E5%8A%A1span"><span id="inline-blue">开启和关闭服务</span></a></li><li><a href="#span-idinline-blue%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%90%AF%E8%87%AA%E5%90%AF%E5%8A%A8span"><span id="inline-blue">设置服务开启自启动</span></a></li></ul><h1><span id="创建elasticsearch启动配置文件"><span id="inline-blue">创建elasticsearch启动配置文件</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 系统自启动服务目录</span></span><br><span class="line">cd /etc/init.d </span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建服务文件</span></span><br><span class="line">vim elasticsearch</span><br></pre></td></tr></table></figure><p>脚本内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chkconfig: 345 63 37</span></span><br><span class="line"><span class="meta">#</span><span class="bash">description: elasticsearch</span></span><br><span class="line"><span class="meta">#</span><span class="bash">processname: elasticsearch-2.4.4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> elasticsearch目录</span></span><br><span class="line">export ES_HOME=/usr/local/elasticsearch-2.4.4</span><br><span class="line"><span class="meta">#</span><span class="bash">java目录</span></span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_171</span><br><span class="line"><span class="meta">#</span><span class="bash">需要创建对应es用户</span></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd $ES_HOME</span><br><span class="line">    ./bin/elasticsearch -d -p pid</span><br><span class="line">    exit</span><br><span class="line">!</span><br><span class="line">    echo &quot;elasticsearch is started&quot;</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    pid=`cat $ES_HOME/pid`</span><br><span class="line">    kill -9 $pid</span><br><span class="line">    echo &quot;elasticsearch is stopped&quot;</span><br><span class="line">    ;;</span><br><span class="line">restart)</span><br><span class="line">    pid=`cat $ES_HOME/pid`</span><br><span class="line">    kill -9 $pid</span><br><span class="line">    echo &quot;elasticsearch is stopped&quot;</span><br><span class="line">    sleep 1</span><br><span class="line">    su es&lt;&lt;!</span><br><span class="line">    cd $ES_HOME</span><br><span class="line">    ./bin/elasticsearch -d -p pid</span><br><span class="line">    exit</span><br><span class="line">!</span><br><span class="line">    echo &quot;elasticsearch is started&quot;</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    echo &quot;start|stop|restart&quot;</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1><span id="修改文件权限"><span id="inline-blue">修改文件权限</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 elasticsearch</span><br></pre></td></tr></table></figure><h1><span id="添加和删除自启动服务"><span id="inline-blue">添加和删除自启动服务</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">添加服务</span></span><br><span class="line">chkconfig --add elasticsearch</span><br><span class="line"><span class="meta">#</span><span class="bash">删除服务</span></span><br><span class="line">chkconfig --del elasticsearch</span><br></pre></td></tr></table></figure><h1><span id="开启和关闭服务"><span id="inline-blue">开启和关闭服务</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动</span></span><br><span class="line">service elasticsearch start</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭</span></span><br><span class="line">service elasticsearch stop</span><br><span class="line"><span class="meta">#</span><span class="bash">查看状态</span></span><br><span class="line">service elasticsearch status</span><br></pre></td></tr></table></figure><h1><span id="设置服务开启自启动"><span id="inline-blue">设置服务开启自启动</span></span></h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">开启</span></span><br><span class="line">chkconfig elasticsearch  on</span><br><span class="line"><span class="meta">#</span><span class="bash">关闭</span></span><br><span class="line">chkconfig elasticsearch  off</span><br><span class="line"><span class="meta">#</span><span class="bash">查看自启动服务状态</span></span><br><span class="line">chkconfig  --list</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Nginx/blogs/Nginx%E9%85%8D%E7%BD%AEMySQL%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Nginx/blogs/Nginx%E9%85%8D%E7%BD%AEMySQL%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91/" class="post-title-link" itemprop="url">Nginx配置MySQL请求转发</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-12 11:26:20" itemprop="dateCreated datePublished" datetime="2024-01-12T11:26:20+08:00">2024-01-12</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%9B%AE%E7%9A%84span"><span id="inline-blue">目的</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a><ul><li><a href="#span-idinline-bluenginx%E9%85%8D%E7%BD%AEspan"><span id="inline-blue">nginx配置</span></a></li></ul></li><li><a href="#span-idinline-blue%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AEspan"><span id="inline-blue">数据库连接配置</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>linux : CentOS Linux release 7.7.1908 (Core)<br>nginx : 1.18.1<br>MySQL : 5.7</p><h1><span id="目的"><span id="inline-blue">目的</span></span></h1><p>通过nginx转发MySQL请求，解决内网环境和MySQL网络不能通信的情况</p><h1><span id="实现"><span id="inline-blue">实现</span></span></h1><p>查看当前nginx版本是否支持ssl</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">./nginx -V</span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br></pre></td></tr></table></figure><p>—-with-stream 说明nginx编译时已添加stream模块支持。<br>如果没有对应的模块需要备份nginx配置，添加—-with-stream参数支持重新编译nginx并安装。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--sbin-path=/usr/local/nginx/sbin/nginx \</span><br><span class="line">--modules-path=/usr/local/nginx/modules \</span><br><span class="line">--conf-path=/usr/local/nginx/conf/nginx.conf \</span><br><span class="line">--error-log-path=/usr/local/nginx/logs/error.log \</span><br><span class="line">--http-log-path=/usr/local/nginx/logs/access.log \</span><br><span class="line">--pid-path=/usr/local/nginx/logs/nginx.pid \</span><br><span class="line">--lock-path=/usr/local/nginx/logs/nginx.lock \</span><br><span class="line">--with-http_gzip_static_module \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-stream</span><br></pre></td></tr></table></figure><h2><span id="nginx配置"><span id="inline-blue">nginx配置</span></span></h2><p>nginx当前所在服务器为10.9.216.12,,监听3308端口，将请求转发到10.9.216.14:3306</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">user  root;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream mysqlupstream &#123;</span><br><span class="line">       hash $remote_addr consistent;</span><br><span class="line">       server 10.9.216.14:3306 weight=5 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">       listen 3308;</span><br><span class="line">       proxy_connect_timeout 10s;</span><br><span class="line">       proxy_timeout 300s;</span><br><span class="line">       proxy_pass mysqlupstream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>strean节点的内容是对应转发的关键配置，其他的信息主要是用于确定节点添加的位置。</p><h1><span id="数据库连接配置"><span id="inline-blue">数据库连接配置</span></span></h1><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://10.9.216.12:3308/lovehome_xw?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">coship</span></span><br><span class="line"><span class="meta">spring.datasource.name</span>=<span class="string">lovehome_xw</span></span><br><span class="line"><span class="meta">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.datasource.initial-size</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">spring.datasource.min-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">spring.datasource.max-active</span>=<span class="string">20</span></span><br><span class="line"><span class="meta">spring.datasource.max-wait</span>=<span class="string">30000</span></span><br><span class="line"><span class="meta">spring.datasource.time-between-eviction-runs-millis</span>=<span class="string">60000</span></span><br><span class="line"><span class="meta">spring.datasource.min-evictable-idle-time-millis</span>=<span class="string">300000</span></span><br><span class="line"><span class="meta">spring.datasource.validation-query</span>=<span class="string">select &#x27;1&#x27; from dual</span></span><br><span class="line"><span class="meta">spring.datasource.test-while-idle</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.datasource.test-on-borrow</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.datasource.test-on-return</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.datasource.pool-prepared-statements</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.datasource.max-open-prepared-statements</span>=<span class="string">20</span></span><br><span class="line"><span class="meta">spring.datasource.max-pool-prepared-statement-per-connection-size</span>=<span class="string">20</span></span><br><span class="line"><span class="meta">spring.datasource.filters</span>=<span class="string">stat,wall</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Nginx/blogs/Nginx%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0ssl%E5%8A%A0%E5%AF%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Nginx/blogs/Nginx%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0ssl%E5%8A%A0%E5%AF%86/" class="post-title-link" itemprop="url">Nginx配置自定义证书实现ssl加密</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-09 09:50:20" itemprop="dateCreated datePublished" datetime="2024-01-09T09:50:20+08:00">2024-01-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>2.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%9B%AE%E7%9A%84span"><span id="inline-blue">目的</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a><ul><li><a href="#span-idinline-blue%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%89%E5%85%A8%E8%AF%81%E4%B9%A6span"><span id="inline-blue">自定义安全证书</span></a></li><li><a href="#span-idinline-blue%E8%AF%81%E4%B9%A6%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2span"><span id="inline-blue">证书格式转换</span></a></li><li><a href="#span-idinline-blue%E5%AF%BC%E5%87%BA%E8%AF%81%E4%B9%A6span"><span id="inline-blue">导出证书</span></a></li><li><a href="#span-idinline-bluecer%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E4%B8%BApemspan"><span id="inline-blue">cer格式转换为pem</span></a></li><li><a href="#span-idinline-blue%E6%8F%90%E5%8F%96%E7%A7%81%E9%92%A5span"><span id="inline-blue">提取私钥</span></a></li><li><a href="#span-idinline-bluenginx%E9%85%8D%E7%BD%AEspan"><span id="inline-blue">nginx配置</span></a></li></ul></li><li><a href="#span-idinline-blue%E9%AA%8C%E8%AF%81span"><span id="inline-blue">验证</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>linux : CentOS Linux release 7.7.1908 (Core)<br>nginx : 1.18.1</p><h1><span id="目的"><span id="inline-blue">目的</span></span></h1><p>访问nginx添加ssl加密，使用自定义安全证书</p><h1><span id="实现"><span id="inline-blue">实现</span></span></h1><p>查看当前nginx版本是否支持ssl</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">./nginx -V</span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br></pre></td></tr></table></figure><p>–with-http_ssl_module 说明nginx编译时已添加ssl模块支持，如果没有对应标识，需要重新执行nginx编译，命令内容如下，路径参数执行修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">            --sbin-path=/usr/sbin/nginx \</span><br><span class="line">            --modules-path=/usr/lib/nginx/modules \</span><br><span class="line">            --conf-path=/usr/local/nginx/conf/nginx.conf \</span><br><span class="line">            --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">            --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">            --user=nginx \</span><br><span class="line">            --group=nginx \</span><br><span class="line">            --with-http_ssl_module \</span><br><span class="line">			--with-http_v2_module \</span><br><span class="line">			--with-http_realip_module \</span><br><span class="line">			--with-http_stub_status_module \</span><br><span class="line">			--with-http_gzip_static_module \</span><br><span class="line">			--with-pcre --with-stream \</span><br><span class="line">			--with-stream_ssl_module \</span><br><span class="line">			--with-stream_realip_module</span><br></pre></td></tr></table></figure><h2><span id="自定义安全证书"><span id="inline-blue">自定义安全证书</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">指定/home路径下生成certificate.jks证书，秘钥为coshipOk698</span></span><br><span class="line">keytool -genkey -alias coship  -keyalg RSA -keysize 2048 -validity 3650 -ext SAN=dns:www.nginx12.com,ip:10.9.216.12  -keystore /home/certificate.jks -storepass coshipOk698 -dname &quot;CN=www.nginx82.com, OU=www.nginx82.com, O=www.nginx82.com, L=wuhan, ST=wuhan, C=cn&quot;</span><br></pre></td></tr></table></figure><h2><span id="证书格式转换"><span id="inline-blue">证书格式转换</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">certificate.jks是键值对形式的证书，推荐转换为标准格式pkcs12</span></span><br><span class="line">keytool -importkeystore -srckeystore certificate.jks -destkeystore certificate.jks -deststoretype pkcs12</span><br></pre></td></tr></table></figure><h2><span id="导出证书"><span id="inline-blue">导出证书</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">将certificate.jks证书导出，certificate.jks已经是pkcs12格式</span></span><br><span class="line">keytool -export -trustcacerts -alias coship -file /home/cas.crt -keystore /home/certificate.jks -storepass coshipOk698</span><br></pre></td></tr></table></figure><h2><span id="cer格式转换为pem"><span id="inline-blue">cer格式转换为pem</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">将cas.crt格式转换为server.pem，方便nginx使用</span></span><br><span class="line">openssl x509 -inform der -in cas.crt -out server.pem</span><br></pre></td></tr></table></figure><h2><span id="提取私钥"><span id="inline-blue">提取私钥</span></span></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -nocerts -nodes -in certificate.jks -out server.key</span><br></pre></td></tr></table></figure><h2><span id="nginx配置"><span id="inline-blue">nginx配置</span></span></h2><p>将转换后的证书server.pem、server.key 上传到nginx配置对应的目录，当前使用的是默认的/home路径下<br>监听端口为443， ssl_certificate、ssl_certificate_key配置为新增的证书和密钥的路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">		client_max_body_size 1024m;  </span><br><span class="line">        listen       443 ssl;</span><br><span class="line">        server_name  www.nginx12.com;</span><br><span class="line">		</span><br><span class="line">		ssl_certificate      /home/server.pem;</span><br><span class="line">        ssl_certificate_key  /home/server.key;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   /home/dev/dist-prodtest;</span><br><span class="line">            #root   /home/dev/prod; </span><br><span class="line">            index  index.html;</span><br><span class="line">			try_files $uri $uri/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line"><span class="meta">		#</span><span class="bash"> 反向代理</span></span><br><span class="line">		location /prodtest/ &#123;</span><br><span class="line">			proxy_pass http://10.9.216.12:9001/dev/;</span><br><span class="line">			proxy_set_header Host 10.9.216.12;</span><br><span class="line">			proxy_connect_timeout 6;</span><br><span class="line">			proxy_send_timeout 6;</span><br><span class="line">			proxy_read_timeout 6;</span><br><span class="line">			send_timeout 6;</span><br><span class="line">         &#125;</span><br><span class="line">			 </span><br><span class="line"></span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1><span id="验证"><span id="inline-blue">验证</span></span></h1><p><img src="/images/nginx/nginx_20240109_001.png" alt="nginx安全访问验证"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content"><link itemprop="mainEntityOfPage" href="https://github.com/vanishke/hexo/Rsync/blogs/Rsync%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%AE%E5%BD%95%E5%90%8C%E6%AD%A5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="vanishke"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="vanishke随笔"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="undefined | vanishke随笔"><meta itemprop="description" content=""></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/Rsync/blogs/Rsync%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%AE%E5%BD%95%E5%90%8C%E6%AD%A5/" class="post-title-link" itemprop="url">Rsync实现服务器目录同步</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-01-03 14:50:20" itemprop="dateCreated datePublished" datetime="2024-01-03T14:50:20+08:00">2024-01-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Rsync/" itemprop="url" rel="index"><span itemprop="name">Rsync</span></a> </span></span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.9k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#span-idinline-blue%E7%8E%AF%E5%A2%83span"><span id="inline-blue">环境</span></a></li><li><a href="#span-idinline-blue%E7%9B%AE%E7%9A%84span"><span id="inline-blue">目的</span></a></li><li><a href="#span-idinline-blue%E5%AE%9E%E7%8E%B0span"><span id="inline-blue">实现</span></a></li></ul><h1><span id="环境"><span id="inline-blue">环境</span></span></h1><p>linux : CentOS Linux release 7.7.1908 (Core)<br>rsync : rsync-3.0.7<br>inotify : inotify-tools-3.13</p><h1><span id="目的"><span id="inline-blue">目的</span></span></h1><p>管理后台上传到FTP的图片目录，需要通过使用nginx代理给接口下载使用，但nginx如果采用回源方案的话导致在接口大量并发的情况下，nginx源服务器出现报错，代理下载nginx服务器缓存出现异常，不能正常提供下载服务。所以将nginx都修改为代理本地服务器的目录，通过rsync将上传文件的FTP目录同步到nginx服务器，减少回源的时间。</p><h1><span id="实现"><span id="inline-blue">实现</span></span></h1><p>1、先查看linux的内核是否支持inotify，支持inotify的内核最小为2.6.13，输入命令：uname –a。如下图所示，内核为3.10.0，支持inotify：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux S21614 3.10.0-1062.el7.x86_64 #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure><p>2、建立同步ssh信任关系，输入命令：cd $HOME，进入用户根目录。<br>输入命令：ssh-keygen -t rsa (会出现几个提示信息，一直按回车即可)。<br>会在$HOME/.ssh/目录下生成2个文件id_rsa、id_rsa.pub。<br>输入命令：cp id_rsa.pub authorized_keys，将id_rsa.pub拷贝成authorized_keys。<br>将授权密钥分发到nginx服务器(192.168.100.101)上，输入命令：<br>scp ~/.ssh/authorized_keys <a href="mailto:&#114;&#111;&#111;&#x74;&#64;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x31;&#x30;&#48;&#x2e;&#x31;&#48;&#x31;">&#114;&#111;&#111;&#x74;&#64;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#x31;&#x30;&#48;&#x2e;&#x31;&#48;&#x31;</a>:/root/.ssh/<br>如果有多台下载服务器，每台都须运行一次上面的密钥下发命令。<br>3、通过如下命令查看系统是否支持inotify：ll /proc/sys/fs/inotify<br>如果有如下输出，表示系统内核已经支持inotify：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 root root 0 Jan  2 14:59 max_queued_events</span><br><span class="line">-rw-r--r-- 1 root root 0 Jan  2 14:59 max_user_instances</span><br><span class="line">-rw-r--r-- 1 root root 0 Jan  2 14:59 max_user_watches</span><br></pre></td></tr></table></figure><p>5、取得软件包inotify-tools-3.13.tar.gz，放在/tmp下。<br>6、输入命令：tar zvxf inotify-tools-3.13.tar.gz，解压软件包。<br>7、输入命令：cd inotify-tools-3.13，进入解压后的目录。<br>8、输入命令：./configure<br>9、输入命令：make<br>10、输入命令：make install<br>11、在系统下执行命令：man inotify、 man inotifywait、 man inotifywatch即可得到相应的帮助信息，表示inotify安装成功。<br>12、输入命令：rsync，查看rsync是否安装。<br>rsync一般是系统默认安装，如果没有安装就取得软件包，安装方法同inotify。</p><p>1、取得syncapps.sh、versService.dat脚本。<br>syncapps.sh脚本内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Copyright 2010 Shenzhen Coship Electronics Co.,Ltd.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> All Rights Reserved</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">FROM: The <span class="built_in">source</span> directory of iEPGM synchronized to iEPG.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">TO:   The purpose file of iEPGM synchronized to iEPG</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########################################################</span></span></span><br><span class="line">FROM=/home/iepgm/iepgm-jetty/sys/pages/</span><br><span class="line">TO=iEPGService.dat</span><br><span class="line"></span><br><span class="line">PID_FILE=syncapps.pid</span><br><span class="line"></span><br><span class="line">function sync_files</span><br><span class="line">&#123;</span><br><span class="line">   cat $TO | while read DST </span><br><span class="line">   do</span><br><span class="line">   rsync -avzq  --delete --exclude &#x27;/.version&#x27; --exclude &#x27;/.bak&#x27; $FROM $DST</span><br><span class="line">   done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function inotify_func</span><br><span class="line">&#123;</span><br><span class="line">    inotifywait -mrq -e modify,delete,create $&#123;FROM&#125; | while read D E F;do</span><br><span class="line">        # echo &quot;$D : $E : $F&quot;</span><br><span class="line">        sync_files</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function stop</span><br><span class="line">&#123;</span><br><span class="line">    pkill inotifywait &amp;&gt;/dev/null &amp;&amp; rm -f $&#123;PID_FILE&#125; &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">    stop)</span><br><span class="line">        echo -n &quot;Stopping sync service...&quot;</span><br><span class="line">        if [ -e $&#123;PID_FILE&#125; ]; then</span><br><span class="line">            stop</span><br><span class="line">            echo &quot;Stopped&quot;</span><br><span class="line">            exit 0</span><br><span class="line">        else</span><br><span class="line">            echo &quot;pid file not found&quot;</span><br><span class="line">            exit 2</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">    start) </span><br><span class="line">        echo -n &quot;Starting sync service...&quot;</span><br><span class="line">        if [ -f $&#123;PID_FILE&#125; ] &amp;&amp; ((`ps awux | grep -v grep | grep -c inotifywait`)); then</span><br><span class="line">            echo &quot; already running: pid file found ($PID_FILE) and an inotifywait process is running&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        elif [ -f $&#123;PID_FILE&#125; ]; then</span><br><span class="line">            echo -n &quot;(stale pid file)&quot;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        sync_files</span><br><span class="line">        inotify_func&amp;</span><br><span class="line">        </span><br><span class="line">        pid=&quot;$!&quot;</span><br><span class="line">        ps --ppid $pid -o pid,cmd | grep inotifywait | awk &#x27;&#123;print $1&#125;&#x27; &gt; $&#123;PID_FILE&#125;</span><br><span class="line">        </span><br><span class="line">        echo &quot;Started&quot;</span><br><span class="line">        ;;</span><br><span class="line">    restart)</span><br><span class="line">        $0 stop</span><br><span class="line">        $0 start</span><br><span class="line">        exit 0</span><br><span class="line">        ;;</span><br><span class="line">    status)</span><br><span class="line">        echo -n &quot;Getting status for syncer service... &quot;</span><br><span class="line">        pid=`cat $&#123;PID_FILE&#125; 2&gt;/dev/null`</span><br><span class="line">        if [ -f $&#123;PID_FILE&#125; ] &amp;&amp; ((`ps awux | grep -v grep | egrep -c &quot;$pid.*inotifywait&quot;`)); then</span><br><span class="line">            echo &quot;running (pid $pid)&quot;</span><br><span class="line">            exit 0</span><br><span class="line">        elif [ -f $&#123;PID_FILE&#125; ]; then</span><br><span class="line">            echo &quot;not runing (pid file found $pid)&quot;</span><br><span class="line">            exit 3</span><br><span class="line">        elif ((`ps awux | grep -v grep | egrep -c &quot;$pid.*inotifywait&quot;`)); then</span><br><span class="line">            echo &quot;not running (inotifywait procs found)&quot;</span><br><span class="line">            exit 4</span><br><span class="line">        else</span><br><span class="line">            echo &quot;not running&quot;</span><br><span class="line">            exit 5</span><br><span class="line">        fi</span><br><span class="line">        ;;</span><br><span class="line">                </span><br><span class="line">    *)</span><br><span class="line">        echo &quot;Usage error&quot;</span><br><span class="line">        echo &quot;Usage: $0 &lt;start|stop|restart|status&gt;&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>versService.dat脚本脚本内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@172.30.209.43:/usr/local/iepg-jetty/webapps/iepg/pages/</span><br></pre></td></tr></table></figure><p>2、编辑syncapps.sh、versService.dat文件中的同步目录及同步主机节点<br>3、输入命令：chmod +x *.sh，给文件赋可执行权限。<br>4、输入命令：./syncapps.sh start，启动同步工具。<br>启动同步工具的输入命令：./syncapps.sh start<br>停止同步工具的输入命令：./syncapps.sh stop<br>重启同步工具的输入命令：./syncapps.sh restart<br>查看同步工具状态的输入命令：./syncapps.sh status</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><nav class="pagination"><a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2026</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">vanishke</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.6m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">24:56</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/bookmark.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/search/local-search.min.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.7/pdfobject.min.js","integrity":"sha256-ph3Dk89VmuTVXG6x/RDzk53SU9LPdAh1tpv0UvnDZ2I="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/tags/pdf.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/pace.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.2.0/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://github.com/vanishke/hexo/page/10/"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/quicklink.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous"><script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"vanishke","repo":"blog-comments","client_id":"95db1f51f05191be80c5","client_secret":"eccc0bbe52b90a08e97140cece84ee32577172b2","admin_user":"['vanishke']","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.7.2/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"fd46efe9cca932ba064caf546fedea22"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.1/third-party/comments/gitalk.min.js"></script></body></html>